import os
import time
import json
import requests
import textwrap
import usb.core
import usb.util
import argparse
import signal
import sys
import logging
import threading
import gc
import re
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

try:
    import psutil
except Exception:
    psutil = None
from PIL import Image, ImageDraw, ImageFont, ImageOps, ImageEnhance
from pilmoji import Pilmoji
from escpos.printer import Usb
import qrcode

# --- CONFIG (env / CLI overridable) ---
DEFAULT_NTFY_HOST = os.environ.get("NTFY_HOST")
DEFAULT_NTFY_TOPIC = os.environ.get("NTFY_TOPIC")
VENDOR_ID = int(os.environ.get("PRINTER_VENDOR", "0x0fe6"), 16)
PRODUCT_ID = int(os.environ.get("PRINTER_PRODUCT", "0x811e"), 16)
PRINTER_PROFILE = os.environ.get("PRINTER_PROFILE")
MEM_THRESHOLD_PERCENT = int(os.environ.get("MEM_THRESHOLD_PERCENT", "80"))
MEM_RESUME_PERCENT = int(os.environ.get("MEM_RESUME_PERCENT", "70"))
MAX_MESSAGE_LENGTH = int(os.environ.get("MAX_MESSAGE_LENGTH", "300"))
MAX_LINES = int(os.environ.get("MAX_LINES", "3"))
# Paper and printer geometry
PAPER_WIDTH_MM = float(os.environ.get("PAPER_WIDTH_MM", "80"))  # 80mm paper
PRINTER_DPI = int(os.environ.get("PRINTER_DPI", "203"))
X_OFFSET_MM = float(os.environ.get("X_OFFSET_MM", "0"))
Y_OFFSET_MM = float(os.environ.get("Y_OFFSET_MM", "0"))
# Max printable: 72mm on 80mm paper, 48mm on 58mm paper
SAFE_MARGIN_MM = 4.0  # (80mm - 72mm) / 2 = 4mm margin each side

# Calculate pixel dimensions (203 DPI)
# 80mm paper = 639px total, 72mm printable = 575px usable width
PAPER_WIDTH_PX = int(round(PAPER_WIDTH_MM / 25.4 * PRINTER_DPI))  # 639px for 80mm
SAFE_MARGIN_PX = int(round(SAFE_MARGIN_MM / 25.4 * PRINTER_DPI))  # 32px for 4mm
MAX_PRINTABLE_WIDTH_PX = PAPER_WIDTH_PX - (2 * SAFE_MARGIN_PX)    # 575px (72mm)

# Icon mappings (ASCII-friendly for thermal printer)
ICON_PRIORITY = {
    "critical": "[!!!]",
    "high": "[!!]",
    "medium": "[!]",
    "low": "[-]",
}

ICON_STATUS = {
    "done": "[OK]",
    "completed": "[OK]",
    "in_progress": "[WIP]",
    "wip": "[WIP]",
    "todo": "[TODO]",
    "blocked": "[BLOCKED]",
    "on_hold": "[HOLD]",
}

ICON_TYPE = {
    "task": "[T]",
    "bug": "[B]",
    "feature": "[F]",
    "alert": "[A]",
    "order": "[#]",
    "monday_task": "[M]",
}

# Common emoji to text mappings for thermal printer compatibility
EMOJI_MAP = {
    "ðŸ•": "[pizza]",
    "ðŸ”": "[burger]",
    "ðŸ†": "[eggplant]",
    "â˜•": "[coffee]",
    "ðŸŽ‰": "[party]",
    "âœ…": "[check]",
    "âŒ": "[x]",
    "âš ï¸": "[warn]",
    "ðŸ””": "[bell]",
    "ðŸ“…": "[cal]",
    "â°": "[clock]",
    "ðŸ‘": "[+1]",
    "ðŸ‘Ž": "[-1]",
    "â¤ï¸": "[heart]",
    "ðŸ”¥": "[fire]",
    "ðŸ’¡": "[idea]",
    "ðŸ“§": "[mail]",
    "ðŸ“±": "[phone]",
    "ðŸš¨": "[alert]",
    "âœ¨": "[*]",
    "âš¡": "[!]",
}

# Emoji tag to Unicode mapping (for ntfy tag translation)
EMOJI_TAG_MAP = {
    "grinning": "ðŸ˜€",
    "smiley": "ðŸ˜ƒ",
    "smile": "ðŸ˜„",
    "grin": "ðŸ˜",
    "laughing": "ðŸ˜†",
    "sweat_smile": "ðŸ˜…",
    "rofl": "ðŸ¤£",
    "joy": "ðŸ˜‚",
    "slightly_smiling_face": "ðŸ™‚",
    "upside_down_face": "ðŸ™ƒ",
    "wink": "ðŸ˜‰",
    "blush": "ðŸ˜Š",
    "innocent": "ðŸ˜‡",
    "smiling_face_with_three_hearts": "ðŸ¥°",
    "heart_eyes": "ðŸ˜",
    "star_struck": "ðŸ¤©",
    "kissing_heart": "ðŸ˜˜",
    "kissing": "ðŸ˜—",
    "relaxed": "â˜ºï¸",
    "kissing_closed_eyes": "ðŸ˜š",
    "kissing_smiling_eyes": "ðŸ˜™",
    "smiling_face_with_tear": "ðŸ¥²",
    "yum": "ðŸ˜‹",
    "stuck_out_tongue": "ðŸ˜›",
    "stuck_out_tongue_winking_eye": "ðŸ˜œ",
    "zany_face": "ðŸ¤ª",
    "stuck_out_tongue_closed_eyes": "ðŸ˜",
    "money_mouth_face": "ðŸ¤‘",
    "hugs": "ðŸ¤—",
    "hand_over_mouth": "ðŸ¤­",
    "shushing_face": "ðŸ¤«",
    "thinking": "ðŸ¤”",
    "zipper_mouth_face": "ðŸ¤",
    "raised_eyebrow": "ðŸ¤¨",
    "neutral_face": "ðŸ˜",
    "expressionless": "ðŸ˜‘",
    "no_mouth": "ðŸ˜¶",
    "face_in_clouds": "ðŸ˜¶â€ðŸŒ«ï¸",
    "smirk": "ðŸ˜",
    "unamused": "ðŸ˜’",
    "roll_eyes": "ðŸ™„",
    "grimacing": "ðŸ˜¬",
    "face_exhaling": "ðŸ˜®â€ðŸ’¨",
    "lying_face": "ðŸ¤¥",
    "relieved": "ðŸ˜Œ",
    "pensive": "ðŸ˜”",
    "sleepy": "ðŸ˜ª",
    "drooling_face": "ðŸ¤¤",
    "sleeping": "ðŸ˜´",
    "mask": "ðŸ˜·",
    "face_with_thermometer": "ðŸ¤’",
    "face_with_head_bandage": "ðŸ¤•",
    "nauseated_face": "ðŸ¤¢",
    "vomiting_face": "ðŸ¤®",
    "sneezing_face": "ðŸ¤§",
    "hot_face": "ðŸ¥µ",
    "cold_face": "ðŸ¥¶",
    "woozy_face": "ðŸ¥´",
    "dizzy_face": "ðŸ˜µ",
    "face_with_spiral_eyes": "ðŸ˜µâ€ðŸ’«",
    "exploding_head": "ðŸ¤¯",
    "cowboy_hat_face": "ðŸ¤ ",
    "partying_face": "ðŸ¥³",
    "disguised_face": "ðŸ¥¸",
    "sunglasses": "ðŸ˜Ž",
    "nerd_face": "ðŸ¤“",
    "monocle_face": "ðŸ§",
    "confused": "ðŸ˜•",
    "worried": "ðŸ˜Ÿ",
    "slightly_frowning_face": "ðŸ™",
    "frowning_face": "â˜¹ï¸",
    "open_mouth": "ðŸ˜®",
    "hushed": "ðŸ˜¯",
    "astonished": "ðŸ˜²",
    "flushed": "ðŸ˜³",
    "pleading_face": "ðŸ¥º",
    "frowning": "ðŸ˜¦",
    "anguished": "ðŸ˜§",
    "fearful": "ðŸ˜¨",
    "cold_sweat": "ðŸ˜°",
    "disappointed_relieved": "ðŸ˜¥",
    "cry": "ðŸ˜¢",
    "sob": "ðŸ˜­",
    "scream": "ðŸ˜±",
    "confounded": "ðŸ˜–",
    "persevere": "ðŸ˜£",
    "disappointed": "ðŸ˜ž",
    "sweat": "ðŸ˜“",
    "weary": "ðŸ˜©",
    "tired_face": "ðŸ˜«",
    "yawning_face": "ðŸ¥±",
    "triumph": "ðŸ˜¤",
    "rage": "ðŸ˜¡",
    "angry": "ðŸ˜ ",
    "cursing_face": "ðŸ¤¬",
    "smiling_imp": "ðŸ˜ˆ",
    "imp": "ðŸ‘¿",
    "skull": "ðŸ’€",
    "skull_and_crossbones": "â˜ ï¸",
    "hankey": "ðŸ’©",
    "clown_face": "ðŸ¤¡",
    "japanese_ogre": "ðŸ‘¹",
    "japanese_goblin": "ðŸ‘º",
    "ghost": "ðŸ‘»",
    "alien": "ðŸ‘½",
    "space_invader": "ðŸ‘¾",
    "robot": "ðŸ¤–",
    "smiley_cat": "ðŸ˜º",
    "smile_cat": "ðŸ˜¸",
    "joy_cat": "ðŸ˜¹",
    "heart_eyes_cat": "ðŸ˜»",
    "smirk_cat": "ðŸ˜¼",
    "kissing_cat": "ðŸ˜½",
    "scream_cat": "ðŸ™€",
    "crying_cat_face": "ðŸ˜¿",
    "pouting_cat": "ðŸ˜¾",
    "see_no_evil": "ðŸ™ˆ",
    "hear_no_evil": "ðŸ™‰",
    "speak_no_evil": "ðŸ™Š",
    "kiss": "ðŸ’‹",
    "love_letter": "ðŸ’Œ",
    "cupid": "ðŸ’˜",
    "gift_heart": "ðŸ’",
    "sparkling_heart": "ðŸ’–",
    "heartpulse": "ðŸ’—",
    "heartbeat": "ðŸ’“",
    "revolving_hearts": "ðŸ’ž",
    "two_hearts": "ðŸ’•",
    "heart_decoration": "ðŸ’Ÿ",
    "heavy_heart_exclamation": "â£ï¸",
    "broken_heart": "ðŸ’”",
    "heart_on_fire": "â¤ï¸â€ðŸ”¥",
    "mending_heart": "â¤ï¸â€ðŸ©¹",
    "heart": "â¤ï¸",
    "orange_heart": "ðŸ§¡",
    "yellow_heart": "ðŸ’›",
    "green_heart": "ðŸ’š",
    "blue_heart": "ðŸ’™",
    "purple_heart": "ðŸ’œ",
    "brown_heart": "ðŸ¤Ž",
    "black_heart": "ðŸ–¤",
    "white_heart": "ðŸ¤",
    "100": "ðŸ’¯",
    "anger": "ðŸ’¢",
    "boom": "ðŸ’¥",
    "dizzy": "ðŸ’«",
    "sweat_drops": "ðŸ’¦",
    "dash": "ðŸ’¨",
    "hole": "ðŸ•³ï¸",
    "bomb": "ðŸ’£",
    "speech_balloon": "ðŸ’¬",
    "eye_speech_bubble": "ðŸ‘ï¸â€ðŸ—¨ï¸",
    "left_speech_bubble": "ðŸ—¨ï¸",
    "right_anger_bubble": "ðŸ—¯ï¸",
    "thought_balloon": "ðŸ’­",
    "zzz": "ðŸ’¤",
    "wave": "ðŸ‘‹",
    "raised_back_of_hand": "ðŸ¤š",
    "raised_hand_with_fingers_splayed": "ðŸ–ï¸",
    "hand": "âœ‹",
    "vulcan_salute": "ðŸ––",
    "ok_hand": "ðŸ‘Œ",
    "pinched_fingers": "ðŸ¤Œ",
    "pinching_hand": "ðŸ¤",
    "v": "âœŒï¸",
    "crossed_fingers": "ðŸ¤ž",
    "love_you_gesture": "ðŸ¤Ÿ",
    "metal": "ðŸ¤˜",
    "call_me_hand": "ðŸ¤™",
    "point_left": "ðŸ‘ˆ",
    "point_right": "ðŸ‘‰",
    "point_up_2": "ðŸ‘†",
    "middle_finger": "ðŸ–•",
    "point_down": "ðŸ‘‡",
    "point_up": "â˜ï¸",
    "plus1": "ðŸ‘",
    "minus1": "ðŸ‘Ž",
    "fist_raised": "âœŠ",
    "fist_oncoming": "ðŸ‘Š",
    "fist_left": "ðŸ¤›",
    "fist_right": "ðŸ¤œ",
    "clap": "ðŸ‘",
    "raised_hands": "ðŸ™Œ",
    "open_hands": "ðŸ‘",
    "palms_up_together": "ðŸ¤²",
    "handshake": "ðŸ¤",
    "pray": "ðŸ™",
    "writing_hand": "âœï¸",
    "nail_care": "ðŸ’…",
    "selfie": "ðŸ¤³",
    "muscle": "ðŸ’ª",
    "mechanical_arm": "ðŸ¦¾",
    "mechanical_leg": "ðŸ¦¿",
    "leg": "ðŸ¦µ",
    "foot": "ðŸ¦¶",
    "ear": "ðŸ‘‚",
    "ear_with_hearing_aid": "ðŸ¦»",
    "nose": "ðŸ‘ƒ",
    "brain": "ðŸ§ ",
    "anatomical_heart": "ðŸ«€",
    "lungs": "ðŸ«",
    "tooth": "ðŸ¦·",
    "bone": "ðŸ¦´",
    "eyes": "ðŸ‘€",
    "eye": "ðŸ‘ï¸",
    "tongue": "ðŸ‘…",
    "lips": "ðŸ‘„",
    "baby": "ðŸ‘¶",
    "child": "ðŸ§’",
    "boy": "ðŸ‘¦",
    "girl": "ðŸ‘§",
    "adult": "ðŸ§‘",
    "blond_haired_person": "ðŸ‘±",
    "man": "ðŸ‘¨",
    "bearded_person": "ðŸ§”",
    "man_beard": "ðŸ§”â€â™‚ï¸",
    "woman_beard": "ðŸ§”â€â™€ï¸",
    "red_haired_man": "ðŸ‘¨â€ðŸ¦°",
    "curly_haired_man": "ðŸ‘¨â€ðŸ¦±",
    "white_haired_man": "ðŸ‘¨â€ðŸ¦³",
    "bald_man": "ðŸ‘¨â€ðŸ¦²",
    "woman": "ðŸ‘©",
    "red_haired_woman": "ðŸ‘©â€ðŸ¦°",
    "person_red_hair": "ðŸ§‘â€ðŸ¦°",
    "curly_haired_woman": "ðŸ‘©â€ðŸ¦±",
    "person_curly_hair": "ðŸ§‘â€ðŸ¦±",
    "white_haired_woman": "ðŸ‘©â€ðŸ¦³",
    "person_white_hair": "ðŸ§‘â€ðŸ¦³",
    "bald_woman": "ðŸ‘©â€ðŸ¦²",
    "person_bald": "ðŸ§‘â€ðŸ¦²",
    "blond_haired_woman": "ðŸ‘±â€â™€ï¸",
    "blond_haired_man": "ðŸ‘±â€â™‚ï¸",
    "older_adult": "ðŸ§“",
    "older_man": "ðŸ‘´",
    "older_woman": "ðŸ‘µ",
    "frowning_person": "ðŸ™",
    "frowning_man": "ðŸ™â€â™‚ï¸",
    "frowning_woman": "ðŸ™â€â™€ï¸",
    "pouting_face": "ðŸ™Ž",
    "pouting_man": "ðŸ™Žâ€â™‚ï¸",
    "pouting_woman": "ðŸ™Žâ€â™€ï¸",
    "no_good": "ðŸ™…",
    "no_good_man": "ðŸ™…â€â™‚ï¸",
    "no_good_woman": "ðŸ™…â€â™€ï¸",
    "ok_person": "ðŸ™†",
    "ok_man": "ðŸ™†â€â™‚ï¸",
    "ok_woman": "ðŸ™†â€â™€ï¸",
    "tipping_hand_person": "ðŸ’",
    "tipping_hand_man": "ðŸ’â€â™‚ï¸",
    "tipping_hand_woman": "ðŸ’â€â™€ï¸",
    "raising_hand": "ðŸ™‹",
    "raising_hand_man": "ðŸ™‹â€â™‚ï¸",
    "raising_hand_woman": "ðŸ™‹â€â™€ï¸",
    "deaf_person": "ðŸ§",
    "deaf_man": "ðŸ§â€â™‚ï¸",
    "deaf_woman": "ðŸ§â€â™€ï¸",
    "bow": "ðŸ™‡",
    "bowing_man": "ðŸ™‡â€â™‚ï¸",
    "bowing_woman": "ðŸ™‡â€â™€ï¸",
    "facepalm": "ðŸ¤¦",
    "man_facepalming": "ðŸ¤¦â€â™‚ï¸",
    "woman_facepalming": "ðŸ¤¦â€â™€ï¸",
    "shrug": "ðŸ¤·",
    "man_shrugging": "ðŸ¤·â€â™‚ï¸",
    "woman_shrugging": "ðŸ¤·â€â™€ï¸",
    "health_worker": "ðŸ§‘â€âš•ï¸",
    "man_health_worker": "ðŸ‘¨â€âš•ï¸",
    "woman_health_worker": "ðŸ‘©â€âš•ï¸",
    "student": "ðŸ§‘â€ðŸŽ“",
    "man_student": "ðŸ‘¨â€ðŸŽ“",
    "woman_student": "ðŸ‘©â€ðŸŽ“",
    "teacher": "ðŸ§‘â€ðŸ«",
    "man_teacher": "ðŸ‘¨â€ðŸ«",
    "woman_teacher": "ðŸ‘©â€ðŸ«",
    "judge": "ðŸ§‘â€âš–ï¸",
    "man_judge": "ðŸ‘¨â€âš–ï¸",
    "woman_judge": "ðŸ‘©â€âš–ï¸",
    "farmer": "ðŸ§‘â€ðŸŒ¾",
    "man_farmer": "ðŸ‘¨â€ðŸŒ¾",
    "woman_farmer": "ðŸ‘©â€ðŸŒ¾",
    "cook": "ðŸ§‘â€ðŸ³",
    "man_cook": "ðŸ‘¨â€ðŸ³",
    "woman_cook": "ðŸ‘©â€ðŸ³",
    "mechanic": "ðŸ§‘â€ðŸ”§",
    "man_mechanic": "ðŸ‘¨â€ðŸ”§",
    "woman_mechanic": "ðŸ‘©â€ðŸ”§",
    "factory_worker": "ðŸ§‘â€ðŸ­",
    "man_factory_worker": "ðŸ‘¨â€ðŸ­",
    "woman_factory_worker": "ðŸ‘©â€ðŸ­",
    "office_worker": "ðŸ§‘â€ðŸ’¼",
    "man_office_worker": "ðŸ‘¨â€ðŸ’¼",
    "woman_office_worker": "ðŸ‘©â€ðŸ’¼",
    "scientist": "ðŸ§‘â€ðŸ”¬",
    "man_scientist": "ðŸ‘¨â€ðŸ”¬",
    "woman_scientist": "ðŸ‘©â€ðŸ”¬",
    "technologist": "ðŸ§‘â€ðŸ’»",
    "man_technologist": "ðŸ‘¨â€ðŸ’»",
    "woman_technologist": "ðŸ‘©â€ðŸ’»",
    "singer": "ðŸ§‘â€ðŸŽ¤",
    "man_singer": "ðŸ‘¨â€ðŸŽ¤",
    "woman_singer": "ðŸ‘©â€ðŸŽ¤",
    "artist": "ðŸ§‘â€ðŸŽ¨",
    "man_artist": "ðŸ‘¨â€ðŸŽ¨",
    "woman_artist": "ðŸ‘©â€ðŸŽ¨",
    "pilot": "ðŸ§‘â€âœˆï¸",
    "man_pilot": "ðŸ‘¨â€âœˆï¸",
    "woman_pilot": "ðŸ‘©â€âœˆï¸",
    "astronaut": "ðŸ§‘â€ðŸš€",
    "man_astronaut": "ðŸ‘¨â€ðŸš€",
    "woman_astronaut": "ðŸ‘©â€ðŸš€",
    "firefighter": "ðŸ§‘â€ðŸš’",
    "man_firefighter": "ðŸ‘¨â€ðŸš’",
    "woman_firefighter": "ðŸ‘©â€ðŸš’",
    "police_officer": "ðŸ‘®",
    "policeman": "ðŸ‘®â€â™‚ï¸",
    "policewoman": "ðŸ‘®â€â™€ï¸",
    "detective": "ðŸ•µï¸",
    "male_detective": "ðŸ•µï¸â€â™‚ï¸",
    "female_detective": "ðŸ•µï¸â€â™€ï¸",
    "guard": "ðŸ’‚",
    "guardsman": "ðŸ’‚â€â™‚ï¸",
    "guardswoman": "ðŸ’‚â€â™€ï¸",
    "ninja": "ðŸ¥·",
    "construction_worker": "ðŸ‘·",
    "construction_worker_man": "ðŸ‘·â€â™‚ï¸",
    "construction_worker_woman": "ðŸ‘·â€â™€ï¸",
    "prince": "ðŸ¤´",
    "princess": "ðŸ‘¸",
    "person_with_turban": "ðŸ‘³",
    "man_with_turban": "ðŸ‘³â€â™‚ï¸",
    "woman_with_turban": "ðŸ‘³â€â™€ï¸",
    "man_with_gua_pi_mao": "ðŸ‘²",
    "woman_with_headscarf": "ðŸ§•",
    "person_in_tuxedo": "ðŸ¤µ",
    "man_in_tuxedo": "ðŸ¤µâ€â™‚ï¸",
    "woman_in_tuxedo": "ðŸ¤µâ€â™€ï¸",
    "person_with_veil": "ðŸ‘°",
    "man_with_veil": "ðŸ‘°â€â™‚ï¸",
    "woman_with_veil": "ðŸ‘°â€â™€ï¸",
    "pregnant_woman": "ðŸ¤°",
    "breast_feeding": "ðŸ¤±",
    "woman_feeding_baby": "ðŸ‘©â€ðŸ¼",
    "man_feeding_baby": "ðŸ‘¨â€ðŸ¼",
    "person_feeding_baby": "ðŸ§‘â€ðŸ¼",
    "angel": "ðŸ‘¼",
    "santa": "ðŸŽ…",
    "mrs_claus": "ðŸ¤¶",
    "mx_claus": "ðŸ§‘â€ðŸŽ„",
    "superhero": "ðŸ¦¸",
    "superhero_man": "ðŸ¦¸â€â™‚ï¸",
    "superhero_woman": "ðŸ¦¸â€â™€ï¸",
    "supervillain": "ðŸ¦¹",
    "supervillain_man": "ðŸ¦¹â€â™‚ï¸",
    "supervillain_woman": "ðŸ¦¹â€â™€ï¸",
    "mage": "ðŸ§™",
    "mage_man": "ðŸ§™â€â™‚ï¸",
    "mage_woman": "ðŸ§™â€â™€ï¸",
    "fairy": "ðŸ§š",
    "fairy_man": "ðŸ§šâ€â™‚ï¸",
    "fairy_woman": "ðŸ§šâ€â™€ï¸",
    "vampire": "ðŸ§›",
    "vampire_man": "ðŸ§›â€â™‚ï¸",
    "vampire_woman": "ðŸ§›â€â™€ï¸",
    "merperson": "ðŸ§œ",
    "merman": "ðŸ§œâ€â™‚ï¸",
    "mermaid": "ðŸ§œâ€â™€ï¸",
    "elf": "ðŸ§",
    "elf_man": "ðŸ§â€â™‚ï¸",
    "elf_woman": "ðŸ§â€â™€ï¸",
    "genie": "ðŸ§ž",
    "genie_man": "ðŸ§žâ€â™‚ï¸",
    "genie_woman": "ðŸ§žâ€â™€ï¸",
    "zombie": "ðŸ§Ÿ",
    "zombie_man": "ðŸ§Ÿâ€â™‚ï¸",
    "zombie_woman": "ðŸ§Ÿâ€â™€ï¸",
    "massage": "ðŸ’†",
    "massage_man": "ðŸ’†â€â™‚ï¸",
    "massage_woman": "ðŸ’†â€â™€ï¸",
    "haircut": "ðŸ’‡",
    "haircut_man": "ðŸ’‡â€â™‚ï¸",
    "haircut_woman": "ðŸ’‡â€â™€ï¸",
    "walking": "ðŸš¶",
    "walking_man": "ðŸš¶â€â™‚ï¸",
    "walking_woman": "ðŸš¶â€â™€ï¸",
    "standing_person": "ðŸ§",
    "standing_man": "ðŸ§â€â™‚ï¸",
    "standing_woman": "ðŸ§â€â™€ï¸",
    "kneeling_person": "ðŸ§Ž",
    "kneeling_man": "ðŸ§Žâ€â™‚ï¸",
    "kneeling_woman": "ðŸ§Žâ€â™€ï¸",
    "person_with_probing_cane": "ðŸ§‘â€ðŸ¦¯",
    "man_with_probing_cane": "ðŸ‘¨â€ðŸ¦¯",
    "woman_with_probing_cane": "ðŸ‘©â€ðŸ¦¯",
    "person_in_motorized_wheelchair": "ðŸ§‘â€ðŸ¦¼",
    "man_in_motorized_wheelchair": "ðŸ‘¨â€ðŸ¦¼",
    "woman_in_motorized_wheelchair": "ðŸ‘©â€ðŸ¦¼",
    "person_in_manual_wheelchair": "ðŸ§‘â€ðŸ¦½",
    "man_in_manual_wheelchair": "ðŸ‘¨â€ðŸ¦½",
    "woman_in_manual_wheelchair": "ðŸ‘©â€ðŸ¦½",
    "runner": "ðŸƒ",
    "running_man": "ðŸƒâ€â™‚ï¸",
    "running_woman": "ðŸƒâ€â™€ï¸",
    "woman_dancing": "ðŸ’ƒ",
    "man_dancing": "ðŸ•º",
    "business_suit_levitating": "ðŸ•´ï¸",
    "dancers": "ðŸ‘¯",
    "dancing_men": "ðŸ‘¯â€â™‚ï¸",
    "dancing_women": "ðŸ‘¯â€â™€ï¸",
    "sauna_person": "ðŸ§–",
    "sauna_man": "ðŸ§–â€â™‚ï¸",
    "sauna_woman": "ðŸ§–â€â™€ï¸",
    "climbing": "ðŸ§—",
    "climbing_man": "ðŸ§—â€â™‚ï¸",
    "climbing_woman": "ðŸ§—â€â™€ï¸",
    "person_fencing": "ðŸ¤º",
    "horse_racing": "ðŸ‡",
    "skier": "â›·ï¸",
    "snowboarder": "ðŸ‚",
    "golfing": "ðŸŒï¸",
    "golfing_man": "ðŸŒï¸â€â™‚ï¸",
    "golfing_woman": "ðŸŒï¸â€â™€ï¸",
    "surfer": "ðŸ„",
    "surfing_man": "ðŸ„â€â™‚ï¸",
    "surfing_woman": "ðŸ„â€â™€ï¸",
    "rowboat": "ðŸš£",
    "rowing_man": "ðŸš£â€â™‚ï¸",
    "rowing_woman": "ðŸš£â€â™€ï¸",
    "swimmer": "ðŸŠ",
    "swimming_man": "ðŸŠâ€â™‚ï¸",
    "swimming_woman": "ðŸŠâ€â™€ï¸",
    "bouncing_ball_person": "â›¹ï¸",
    "bouncing_ball_man": "â›¹ï¸â€â™‚ï¸",
    "bouncing_ball_woman": "â›¹ï¸â€â™€ï¸",
    "weight_lifting": "ðŸ‹ï¸",
    "weight_lifting_man": "ðŸ‹ï¸â€â™‚ï¸",
    "weight_lifting_woman": "ðŸ‹ï¸â€â™€ï¸",
    "bicyclist": "ðŸš´",
    "biking_man": "ðŸš´â€â™‚ï¸",
    "biking_woman": "ðŸš´â€â™€ï¸",
    "mountain_bicyclist": "ðŸšµ",
    "mountain_biking_man": "ðŸšµâ€â™‚ï¸",
    "mountain_biking_woman": "ðŸšµâ€â™€ï¸",
    "cartwheeling": "ðŸ¤¸",
    "man_cartwheeling": "ðŸ¤¸â€â™‚ï¸",
    "woman_cartwheeling": "ðŸ¤¸â€â™€ï¸",
    "wrestling": "ðŸ¤¼",
    "men_wrestling": "ðŸ¤¼â€â™‚ï¸",
    "women_wrestling": "ðŸ¤¼â€â™€ï¸",
    "water_polo": "ðŸ¤½",
    "man_playing_water_polo": "ðŸ¤½â€â™‚ï¸",
    "woman_playing_water_polo": "ðŸ¤½â€â™€ï¸",
    "handball_person": "ðŸ¤¾",
    "man_playing_handball": "ðŸ¤¾â€â™‚ï¸",
    "woman_playing_handball": "ðŸ¤¾â€â™€ï¸",
    "juggling_person": "ðŸ¤¹",
    "man_juggling": "ðŸ¤¹â€â™‚ï¸",
    "woman_juggling": "ðŸ¤¹â€â™€ï¸",
    "lotus_position": "ðŸ§˜",
    "lotus_position_man": "ðŸ§˜â€â™‚ï¸",
    "lotus_position_woman": "ðŸ§˜â€â™€ï¸",
    "bath": "ðŸ›€",
    "sleeping_bed": "ðŸ›Œ",
    "people_holding_hands": "ðŸ§‘â€ðŸ¤â€ðŸ§‘",
    "two_women_holding_hands": "ðŸ‘­",
    "couple": "ðŸ‘«",
    "two_men_holding_hands": "ðŸ‘¬",
    "couplekiss": "ðŸ’",
    "couplekiss_man_woman": "ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨",
    "couplekiss_man_man": "ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨",
    "couplekiss_woman_woman": "ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©",
    "couple_with_heart": "ðŸ’‘",
    "couple_with_heart_woman_man": "ðŸ‘©â€â¤ï¸â€ðŸ‘¨",
    "couple_with_heart_man_man": "ðŸ‘¨â€â¤ï¸â€ðŸ‘¨",
    "couple_with_heart_woman_woman": "ðŸ‘©â€â¤ï¸â€ðŸ‘©",
    "family": "ðŸ‘ª",
    "family_man_woman_boy": "ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦",
    "family_man_woman_girl": "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§",
    "family_man_woman_girl_boy": "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
    "family_man_woman_boy_boy": "ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
    "family_man_woman_girl_girl": "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
    "family_man_man_boy": "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦",
    "family_man_man_girl": "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§",
    "family_man_man_girl_boy": "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦",
    "family_man_man_boy_boy": "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦",
    "family_man_man_girl_girl": "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
    "family_woman_woman_boy": "ðŸ‘©â€ðŸ‘©â€ðŸ‘¦",
    "family_woman_woman_girl": "ðŸ‘©â€ðŸ‘©â€ðŸ‘§",
    "family_woman_woman_girl_boy": "ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
    "family_woman_woman_boy_boy": "ðŸ‘©â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
    "family_woman_woman_girl_girl": "ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
    "family_man_boy": "ðŸ‘¨â€ðŸ‘¦",
    "family_man_boy_boy": "ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦",
    "family_man_girl": "ðŸ‘¨â€ðŸ‘§",
    "family_man_girl_boy": "ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦",
    "family_man_girl_girl": "ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
    "family_woman_boy": "ðŸ‘©â€ðŸ‘¦",
    "family_woman_boy_boy": "ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
    "family_woman_girl": "ðŸ‘©â€ðŸ‘§",
    "family_woman_girl_boy": "ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
    "family_woman_girl_girl": "ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
    "speaking_head": "ðŸ—£ï¸",
    "bust_in_silhouette": "ðŸ‘¤",
    "busts_in_silhouette": "ðŸ‘¥",
    "people_hugging": "ðŸ«‚",
    "footprints": "ðŸ‘£",
    "monkey_face": "ðŸµ",
    "monkey": "ðŸ’",
    "gorilla": "ðŸ¦",
    "orangutan": "ðŸ¦§",
    "dog": "ðŸ¶",
    "dog2": "ðŸ•",
    "guide_dog": "ðŸ¦®",
    "service_dog": "ðŸ•â€ðŸ¦º",
    "poodle": "ðŸ©",
    "wolf": "ðŸº",
    "fox_face": "ðŸ¦Š",
    "raccoon": "ðŸ¦",
    "cat": "ðŸ±",
    "cat2": "ðŸˆ",
    "black_cat": "ðŸˆâ€â¬›",
    "lion": "ðŸ¦",
    "tiger": "ðŸ¯",
    "tiger2": "ðŸ…",
    "leopard": "ðŸ†",
    "horse": "ðŸ´",
    "racehorse": "ðŸŽ",
    "unicorn": "ðŸ¦„",
    "zebra": "ðŸ¦“",
    "deer": "ðŸ¦Œ",
    "bison": "ðŸ¦¬",
    "cow": "ðŸ®",
    "ox": "ðŸ‚",
    "water_buffalo": "ðŸƒ",
    "cow2": "ðŸ„",
    "pig": "ðŸ·",
    "pig2": "ðŸ–",
    "boar": "ðŸ—",
    "pig_nose": "ðŸ½",
    "ram": "ðŸ",
    "sheep": "ðŸ‘",
    "goat": "ðŸ",
    "dromedary_camel": "ðŸª",
    "camel": "ðŸ«",
    "llama": "ðŸ¦™",
    "giraffe": "ðŸ¦’",
    "elephant": "ðŸ˜",
    "mammoth": "ðŸ¦£",
    "rhinoceros": "ðŸ¦",
    "hippopotamus": "ðŸ¦›",
    "mouse": "ðŸ­",
    "mouse2": "ðŸ",
    "rat": "ðŸ€",
    "hamster": "ðŸ¹",
    "rabbit": "ðŸ°",
    "rabbit2": "ðŸ‡",
    "chipmunk": "ðŸ¿ï¸",
    "beaver": "ðŸ¦«",
    "hedgehog": "ðŸ¦”",
    "bat": "ðŸ¦‡",
    "bear": "ðŸ»",
    "polar_bear": "ðŸ»â€â„ï¸",
    "koala": "ðŸ¨",
    "panda_face": "ðŸ¼",
    "sloth": "ðŸ¦¥",
    "otter": "ðŸ¦¦",
    "skunk": "ðŸ¦¨",
    "kangaroo": "ðŸ¦˜",
    "badger": "ðŸ¦¡",
    "feet": "ðŸ¾",
    "turkey": "ðŸ¦ƒ",
    "chicken": "ðŸ”",
    "rooster": "ðŸ“",
    "hatching_chick": "ðŸ£",
    "baby_chick": "ðŸ¤",
    "hatched_chick": "ðŸ¥",
    "bird": "ðŸ¦",
    "penguin": "ðŸ§",
    "dove": "ðŸ•Šï¸",
    "eagle": "ðŸ¦…",
    "duck": "ðŸ¦†",
    "swan": "ðŸ¦¢",
    "owl": "ðŸ¦‰",
    "dodo": "ðŸ¦¤",
    "feather": "ðŸª¶",
    "flamingo": "ðŸ¦©",
    "peacock": "ðŸ¦š",
    "parrot": "ðŸ¦œ",
    "frog": "ðŸ¸",
    "crocodile": "ðŸŠ",
    "turtle": "ðŸ¢",
    "lizard": "ðŸ¦Ž",
    "snake": "ðŸ",
    "dragon_face": "ðŸ²",
    "dragon": "ðŸ‰",
    "sauropod": "ðŸ¦•",
    "t-rex": "ðŸ¦–",
    "whale": "ðŸ³",
    "whale2": "ðŸ‹",
    "dolphin": "ðŸ¬",
    "seal": "ðŸ¦­",
    "fish": "ðŸŸ",
    "tropical_fish": "ðŸ ",
    "blowfish": "ðŸ¡",
    "shark": "ðŸ¦ˆ",
    "octopus": "ðŸ™",
    "shell": "ðŸš",
    "snail": "ðŸŒ",
    "butterfly": "ðŸ¦‹",
    "bug": "ðŸ›",
    "ant": "ðŸœ",
    "bee": "ðŸ",
    "beetle": "ðŸª²",
    "lady_beetle": "ðŸž",
    "cricket": "ðŸ¦—",
    "cockroach": "ðŸª³",
    "spider": "ðŸ•·ï¸",
    "spider_web": "ðŸ•¸ï¸",
    "scorpion": "ðŸ¦‚",
    "mosquito": "ðŸ¦Ÿ",
    "fly": "ðŸª°",
    "worm": "ðŸª±",
    "microbe": "ðŸ¦ ",
    "bouquet": "ðŸ’",
    "cherry_blossom": "ðŸŒ¸",
    "white_flower": "ðŸ’®",
    "rosette": "ðŸµï¸",
    "rose": "ðŸŒ¹",
    "wilted_flower": "ðŸ¥€",
    "hibiscus": "ðŸŒº",
    "sunflower": "ðŸŒ»",
    "blossom": "ðŸŒ¼",
    "tulip": "ðŸŒ·",
    "seedling": "ðŸŒ±",
    "potted_plant": "ðŸª´",
    "evergreen_tree": "ðŸŒ²",
    "deciduous_tree": "ðŸŒ³",
    "palm_tree": "ðŸŒ´",
    "cactus": "ðŸŒµ",
    "ear_of_rice": "ðŸŒ¾",
    "herb": "ðŸŒ¿",
    "shamrock": "â˜˜ï¸",
    "four_leaf_clover": "ðŸ€",
    "maple_leaf": "ðŸ",
    "fallen_leaf": "ðŸ‚",
    "leaves": "ðŸƒ",
    "grapes": "ðŸ‡",
    "melon": "ðŸˆ",
    "watermelon": "ðŸ‰",
    "tangerine": "ðŸŠ",
    "lemon": "ðŸ‹",
    "banana": "ðŸŒ",
    "pineapple": "ðŸ",
    "mango": "ðŸ¥­",
    "apple": "ðŸŽ",
    "green_apple": "ðŸ",
    "pear": "ðŸ",
    "peach": "ðŸ‘",
    "cherries": "ðŸ’",
    "strawberry": "ðŸ“",
    "blueberries": "ðŸ«",
    "kiwi_fruit": "ðŸ¥",
    "tomato": "ðŸ…",
    "olive": "ðŸ«’",
    "coconut": "ðŸ¥¥",
    "avocado": "ðŸ¥‘",
    "eggplant": "ðŸ†",
    "potato": "ðŸ¥”",
    "carrot": "ðŸ¥•",
    "corn": "ðŸŒ½",
    "hot_pepper": "ðŸŒ¶ï¸",
    "bell_pepper": "ðŸ«‘",
    "cucumber": "ðŸ¥’",
    "leafy_green": "ðŸ¥¬",
    "broccoli": "ðŸ¥¦",
    "garlic": "ðŸ§„",
    "onion": "ðŸ§…",
    "mushroom": "ðŸ„",
    "peanuts": "ðŸ¥œ",
    "chestnut": "ðŸŒ°",
    "bread": "ðŸž",
    "croissant": "ðŸ¥",
    "baguette_bread": "ðŸ¥–",
    "flatbread": "ðŸ«“",
    "pretzel": "ðŸ¥¨",
    "bagel": "ðŸ¥¯",
    "pancakes": "ðŸ¥ž",
    "waffle": "ðŸ§‡",
    "cheese": "ðŸ§€",
    "meat_on_bone": "ðŸ–",
    "poultry_leg": "ðŸ—",
    "cut_of_meat": "ðŸ¥©",
    "bacon": "ðŸ¥“",
    "hamburger": "ðŸ”",
    "fries": "ðŸŸ",
    "pizza": "ðŸ•",
    "hotdog": "ðŸŒ­",
    "sandwich": "ðŸ¥ª",
    "taco": "ðŸŒ®",
    "burrito": "ðŸŒ¯",
    "tamale": "ðŸ«”",
    "stuffed_flatbread": "ðŸ¥™",
    "falafel": "ðŸ§†",
    "egg": "ðŸ¥š",
    "fried_egg": "ðŸ³",
    "shallow_pan_of_food": "ðŸ¥˜",
    "stew": "ðŸ²",
    "fondue": "ðŸ«•",
    "bowl_with_spoon": "ðŸ¥£",
    "green_salad": "ðŸ¥—",
    "popcorn": "ðŸ¿",
    "butter": "ðŸ§ˆ",
    "salt": "ðŸ§‚",
    "canned_food": "ðŸ¥«",
    "bento": "ðŸ±",
    "rice_cracker": "ðŸ˜",
    "rice_ball": "ðŸ™",
    "rice": "ðŸš",
    "curry": "ðŸ›",
    "ramen": "ðŸœ",
    "spaghetti": "ðŸ",
    "sweet_potato": "ðŸ ",
    "oden": "ðŸ¢",
    "sushi": "ðŸ£",
    "fried_shrimp": "ðŸ¤",
    "fish_cake": "ðŸ¥",
    "moon_cake": "ðŸ¥®",
    "dango": "ðŸ¡",
    "dumpling": "ðŸ¥Ÿ",
    "fortune_cookie": "ðŸ¥ ",
    "takeout_box": "ðŸ¥¡",
    "crab": "ðŸ¦€",
    "lobster": "ðŸ¦ž",
    "shrimp": "ðŸ¦",
    "squid": "ðŸ¦‘",
    "oyster": "ðŸ¦ª",
    "icecream": "ðŸ¦",
    "shaved_ice": "ðŸ§",
    "ice_cream": "ðŸ¨",
    "doughnut": "ðŸ©",
    "cookie": "ðŸª",
    "birthday": "ðŸŽ‚",
    "cake": "ðŸ°",
    "cupcake": "ðŸ§",
    "pie": "ðŸ¥§",
    "chocolate_bar": "ðŸ«",
    "candy": "ðŸ¬",
    "lollipop": "ðŸ­",
    "custard": "ðŸ®",
    "honey_pot": "ðŸ¯",
    "baby_bottle": "ðŸ¼",
    "milk_glass": "ðŸ¥›",
    "coffee": "â˜•",
    "teapot": "ðŸ«–",
    "tea": "ðŸµ",
    "sake": "ðŸ¶",
    "champagne": "ðŸ¾",
    "wine_glass": "ðŸ·",
    "cocktail": "ðŸ¸",
    "tropical_drink": "ðŸ¹",
    "beer": "ðŸº",
    "beers": "ðŸ»",
    "clinking_glasses": "ðŸ¥‚",
    "tumbler_glass": "ðŸ¥ƒ",
    "cup_with_straw": "ðŸ¥¤",
    "bubble_tea": "ðŸ§‹",
    "beverage_box": "ðŸ§ƒ",
    "mate": "ðŸ§‰",
    "ice_cube": "ðŸ§Š",
    "chopsticks": "ðŸ¥¢",
    "plate_with_cutlery": "ðŸ½ï¸",
    "fork_and_knife": "ðŸ´",
    "spoon": "ðŸ¥„",
    "hocho": "ðŸ”ª",
    "amphora": "ðŸº",
    "earth_africa": "ðŸŒ",
    "earth_americas": "ðŸŒŽ",
    "earth_asia": "ðŸŒ",
    "globe_with_meridians": "ðŸŒ",
    "world_map": "ðŸ—ºï¸",
    "japan": "ðŸ—¾",
    "compass": "ðŸ§­",
    "mountain_snow": "ðŸ”ï¸",
    "mountain": "â›°ï¸",
    "volcano": "ðŸŒ‹",
    "mount_fuji": "ðŸ—»",
    "camping": "ðŸ•ï¸",
    "beach_umbrella": "ðŸ–ï¸",
    "desert": "ðŸœï¸",
    "desert_island": "ðŸï¸",
    "national_park": "ðŸžï¸",
    "stadium": "ðŸŸï¸",
    "classical_building": "ðŸ›ï¸",
    "building_construction": "ðŸ—ï¸",
    "bricks": "ðŸ§±",
    "rock": "ðŸª¨",
    "wood": "ðŸªµ",
    "hut": "ðŸ›–",
    "houses": "ðŸ˜ï¸",
    "derelict_house": "ðŸšï¸",
    "house": "ðŸ ",
    "house_with_garden": "ðŸ¡",
    "office": "ðŸ¢",
    "post_office": "ðŸ£",
    "european_post_office": "ðŸ¤",
    "hospital": "ðŸ¥",
    "bank": "ðŸ¦",
    "hotel": "ðŸ¨",
    "love_hotel": "ðŸ©",
    "convenience_store": "ðŸª",
    "school": "ðŸ«",
    "department_store": "ðŸ¬",
    "factory": "ðŸ­",
    "japanese_castle": "ðŸ¯",
    "european_castle": "ðŸ°",
    "wedding": "ðŸ’’",
    "tokyo_tower": "ðŸ—¼",
    "statue_of_liberty": "ðŸ—½",
    "church": "â›ª",
    "mosque": "ðŸ•Œ",
    "hindu_temple": "ðŸ›•",
    "synagogue": "ðŸ•",
    "shinto_shrine": "â›©ï¸",
    "kaaba": "ðŸ•‹",
    "fountain": "â›²",
    "tent": "â›º",
    "foggy": "ðŸŒ",
    "night_with_stars": "ðŸŒƒ",
    "cityscape": "ðŸ™ï¸",
    "sunrise_over_mountains": "ðŸŒ„",
    "sunrise": "ðŸŒ…",
    "city_sunset": "ðŸŒ†",
    "city_sunrise": "ðŸŒ‡",
    "bridge_at_night": "ðŸŒ‰",
    "hotsprings": "â™¨ï¸",
    "carousel_horse": "ðŸŽ ",
    "ferris_wheel": "ðŸŽ¡",
    "roller_coaster": "ðŸŽ¢",
    "barber": "ðŸ’ˆ",
    "circus_tent": "ðŸŽª",
    "steam_locomotive": "ðŸš‚",
    "railway_car": "ðŸšƒ",
    "bullettrain_side": "ðŸš„",
    "bullettrain_front": "ðŸš…",
    "train2": "ðŸš†",
    "metro": "ðŸš‡",
    "light_rail": "ðŸšˆ",
    "station": "ðŸš‰",
    "tram": "ðŸšŠ",
    "monorail": "ðŸš",
    "mountain_railway": "ðŸšž",
    "train": "ðŸš‹",
    "bus": "ðŸšŒ",
    "oncoming_bus": "ðŸš",
    "trolleybus": "ðŸšŽ",
    "minibus": "ðŸš",
    "ambulance": "ðŸš‘",
    "fire_engine": "ðŸš’",
    "police_car": "ðŸš“",
    "oncoming_police_car": "ðŸš”",
    "taxi": "ðŸš•",
    "oncoming_taxi": "ðŸš–",
    "car": "ðŸš—",
    "oncoming_automobile": "ðŸš˜",
    "blue_car": "ðŸš™",
    "pickup_truck": "ðŸ›»",
    "truck": "ðŸšš",
    "articulated_lorry": "ðŸš›",
    "tractor": "ðŸšœ",
    "racing_car": "ðŸŽï¸",
    "motorcycle": "ðŸï¸",
    "motor_scooter": "ðŸ›µ",
    "manual_wheelchair": "ðŸ¦½",
    "motorized_wheelchair": "ðŸ¦¼",
    "auto_rickshaw": "ðŸ›º",
    "bike": "ðŸš²",
    "kick_scooter": "ðŸ›´",
    "skateboard": "ðŸ›¹",
    "roller_skate": "ðŸ›¼",
    "busstop": "ðŸš",
    "motorway": "ðŸ›£ï¸",
    "railway_track": "ðŸ›¤ï¸",
    "oil_drum": "ðŸ›¢ï¸",
    "fuelpump": "â›½",
    "rotating_light": "ðŸš¨",
    "traffic_light": "ðŸš¥",
    "vertical_traffic_light": "ðŸš¦",
    "stop_sign": "ðŸ›‘",
    "construction": "ðŸš§",
    "anchor": "âš“",
    "boat": "â›µ",
    "canoe": "ðŸ›¶",
    "speedboat": "ðŸš¤",
    "passenger_ship": "ðŸ›³ï¸",
    "ferry": "â›´ï¸",
    "motor_boat": "ðŸ›¥ï¸",
    "ship": "ðŸš¢",
    "airplane": "âœˆï¸",
    "small_airplane": "ðŸ›©ï¸",
    "flight_departure": "ðŸ›«",
    "flight_arrival": "ðŸ›¬",
    "parachute": "ðŸª‚",
    "seat": "ðŸ’º",
    "helicopter": "ðŸš",
    "suspension_railway": "ðŸšŸ",
    "mountain_cableway": "ðŸš ",
    "aerial_tramway": "ðŸš¡",
    "artificial_satellite": "ðŸ›°ï¸",
    "rocket": "ðŸš€",
    "flying_saucer": "ðŸ›¸",
    "bellhop_bell": "ðŸ›Žï¸",
    "luggage": "ðŸ§³",
    "hourglass": "âŒ›",
    "hourglass_flowing_sand": "â³",
    "watch": "âŒš",
    "alarm_clock": "â°",
    "stopwatch": "â±ï¸",
    "timer_clock": "â²ï¸",
    "mantelpiece_clock": "ðŸ•°ï¸",
    "clock12": "ðŸ•›",
    "clock1230": "ðŸ•§",
    "clock1": "ðŸ•",
    "clock130": "ðŸ•œ",
    "clock2": "ðŸ•‘",
    "clock230": "ðŸ•",
    "clock3": "ðŸ•’",
    "clock330": "ðŸ•ž",
    "clock4": "ðŸ•“",
    "clock430": "ðŸ•Ÿ",
    "clock5": "ðŸ•”",
    "clock530": "ðŸ• ",
    "clock6": "ðŸ••",
    "clock630": "ðŸ•¡",
    "clock7": "ðŸ•–",
    "clock730": "ðŸ•¢",
    "clock8": "ðŸ•—",
    "clock830": "ðŸ•£",
    "clock9": "ðŸ•˜",
    "clock930": "ðŸ•¤",
    "clock10": "ðŸ•™",
    "clock1030": "ðŸ•¥",
    "clock11": "ðŸ•š",
    "clock1130": "ðŸ•¦",
    "new_moon": "ðŸŒ‘",
    "waxing_crescent_moon": "ðŸŒ’",
    "first_quarter_moon": "ðŸŒ“",
    "moon": "ðŸŒ”",
    "full_moon": "ðŸŒ•",
    "waning_gibbous_moon": "ðŸŒ–",
    "last_quarter_moon": "ðŸŒ—",
    "waning_crescent_moon": "ðŸŒ˜",
    "crescent_moon": "ðŸŒ™",
    "new_moon_with_face": "ðŸŒš",
    "first_quarter_moon_with_face": "ðŸŒ›",
    "last_quarter_moon_with_face": "ðŸŒœ",
    "thermometer": "ðŸŒ¡ï¸",
    "sunny": "â˜€ï¸",
    "full_moon_with_face": "ðŸŒ",
    "sun_with_face": "ðŸŒž",
    "ringed_planet": "ðŸª",
    "star": "â­",
    "star2": "ðŸŒŸ",
    "stars": "ðŸŒ ",
    "milky_way": "ðŸŒŒ",
    "cloud": "â˜ï¸",
    "partly_sunny": "â›…",
    "cloud_with_lightning_and_rain": "â›ˆï¸",
    "sun_behind_small_cloud": "ðŸŒ¤ï¸",
    "sun_behind_large_cloud": "ðŸŒ¥ï¸",
    "sun_behind_rain_cloud": "ðŸŒ¦ï¸",
    "cloud_with_rain": "ðŸŒ§ï¸",
    "cloud_with_snow": "ðŸŒ¨ï¸",
    "cloud_with_lightning": "ðŸŒ©ï¸",
    "tornado": "ðŸŒªï¸",
    "fog": "ðŸŒ«ï¸",
    "wind_face": "ðŸŒ¬ï¸",
    "cyclone": "ðŸŒ€",
    "rainbow": "ðŸŒˆ",
    "closed_umbrella": "ðŸŒ‚",
    "open_umbrella": "â˜‚ï¸",
    "umbrella": "â˜”",
    "parasol_on_ground": "â›±ï¸",
    "zap": "âš¡",
    "snowflake": "â„ï¸",
    "snowman_with_snow": "â˜ƒï¸",
    "snowman": "â›„",
    "comet": "â˜„ï¸",
    "fire": "ðŸ”¥",
    "droplet": "ðŸ’§",
    "ocean": "ðŸŒŠ",
    "jack_o_lantern": "ðŸŽƒ",
    "christmas_tree": "ðŸŽ„",
    "fireworks": "ðŸŽ†",
    "sparkler": "ðŸŽ‡",
    "firecracker": "ðŸ§¨",
    "sparkles": "âœ¨",
    "balloon": "ðŸŽˆ",
    "tada": "ðŸŽ‰",
    "confetti_ball": "ðŸŽŠ",
    "tanabata_tree": "ðŸŽ‹",
    "bamboo": "ðŸŽ",
    "dolls": "ðŸŽŽ",
    "flags": "ðŸŽ",
    "wind_chime": "ðŸŽ",
    "rice_scene": "ðŸŽ‘",
    "red_envelope": "ðŸ§§",
    "ribbon": "ðŸŽ€",
    "gift": "ðŸŽ",
    "reminder_ribbon": "ðŸŽ—ï¸",
    "tickets": "ðŸŽŸï¸",
    "ticket": "ðŸŽ«",
    "medal_military": "ðŸŽ–ï¸",
    "trophy": "ðŸ†",
    "medal_sports": "ðŸ…",
    "1st_place_medal": "ðŸ¥‡",
    "2nd_place_medal": "ðŸ¥ˆ",
    "3rd_place_medal": "ðŸ¥‰",
    "soccer": "âš½",
    "baseball": "âš¾",
    "softball": "ðŸ¥Ž",
    "basketball": "ðŸ€",
    "volleyball": "ðŸ",
    "football": "ðŸˆ",
    "rugby_football": "ðŸ‰",
    "tennis": "ðŸŽ¾",
    "flying_disc": "ðŸ¥",
    "bowling": "ðŸŽ³",
    "cricket_game": "ðŸ",
    "field_hockey": "ðŸ‘",
    "ice_hockey": "ðŸ’",
    "lacrosse": "ðŸ¥",
    "ping_pong": "ðŸ“",
    "badminton": "ðŸ¸",
    "boxing_glove": "ðŸ¥Š",
    "martial_arts_uniform": "ðŸ¥‹",
    "goal_net": "ðŸ¥…",
    "golf": "â›³",
    "ice_skate": "â›¸ï¸",
    "fishing_pole_and_fish": "ðŸŽ£",
    "diving_mask": "ðŸ¤¿",
    "running_shirt_with_sash": "ðŸŽ½",
    "ski": "ðŸŽ¿",
    "sled": "ðŸ›·",
    "curling_stone": "ðŸ¥Œ",
    "dart": "ðŸŽ¯",
    "yo_yo": "ðŸª€",
    "kite": "ðŸª",
    "8ball": "ðŸŽ±",
    "crystal_ball": "ðŸ”®",
    "magic_wand": "ðŸª„",
    "nazar_amulet": "ðŸ§¿",
    "video_game": "ðŸŽ®",
    "joystick": "ðŸ•¹ï¸",
    "slot_machine": "ðŸŽ°",
    "game_die": "ðŸŽ²",
    "jigsaw": "ðŸ§©",
    "teddy_bear": "ðŸ§¸",
    "pinata": "ðŸª…",
    "nesting_dolls": "ðŸª†",
    "spades": "â™ ï¸",
    "hearts": "â™¥ï¸",
    "diamonds": "â™¦ï¸",
    "clubs": "â™£ï¸",
    "chess_pawn": "â™Ÿï¸",
    "black_joker": "ðŸƒ",
    "mahjong": "ðŸ€„",
    "flower_playing_cards": "ðŸŽ´",
    "performing_arts": "ðŸŽ­",
    "framed_picture": "ðŸ–¼ï¸",
    "art": "ðŸŽ¨",
    "thread": "ðŸ§µ",
    "sewing_needle": "ðŸª¡",
    "yarn": "ðŸ§¶",
    "knot": "ðŸª¢",
    "eyeglasses": "ðŸ‘“",
    "dark_sunglasses": "ðŸ•¶ï¸",
    "goggles": "ðŸ¥½",
    "lab_coat": "ðŸ¥¼",
    "safety_vest": "ðŸ¦º",
    "necktie": "ðŸ‘”",
    "shirt": "ðŸ‘•",
    "jeans": "ðŸ‘–",
    "scarf": "ðŸ§£",
    "gloves": "ðŸ§¤",
    "coat": "ðŸ§¥",
    "socks": "ðŸ§¦",
    "dress": "ðŸ‘—",
    "kimono": "ðŸ‘˜",
    "sari": "ðŸ¥»",
    "one_piece_swimsuit": "ðŸ©±",
    "swim_brief": "ðŸ©²",
    "shorts": "ðŸ©³",
    "bikini": "ðŸ‘™",
    "womans_clothes": "ðŸ‘š",
    "purse": "ðŸ‘›",
    "handbag": "ðŸ‘œ",
    "pouch": "ðŸ‘",
    "shopping": "ðŸ›ï¸",
    "school_satchel": "ðŸŽ’",
    "thong_sandal": "ðŸ©´",
    "mans_shoe": "ðŸ‘ž",
    "athletic_shoe": "ðŸ‘Ÿ",
    "hiking_boot": "ðŸ¥¾",
    "flat_shoe": "ðŸ¥¿",
    "high_heel": "ðŸ‘ ",
    "sandal": "ðŸ‘¡",
    "ballet_shoes": "ðŸ©°",
    "boot": "ðŸ‘¢",
    "crown": "ðŸ‘‘",
    "womans_hat": "ðŸ‘’",
    "tophat": "ðŸŽ©",
    "mortar_board": "ðŸŽ“",
    "billed_cap": "ðŸ§¢",
    "military_helmet": "ðŸª–",
    "rescue_worker_helmet": "â›‘ï¸",
    "prayer_beads": "ðŸ“¿",
    "lipstick": "ðŸ’„",
    "ring": "ðŸ’",
    "gem": "ðŸ’Ž",
    "mute": "ðŸ”‡",
    "speaker": "ðŸ”ˆ",
    "sound": "ðŸ”‰",
    "loud_sound": "ðŸ”Š",
    "loudspeaker": "ðŸ“¢",
    "mega": "ðŸ“£",
    "postal_horn": "ðŸ“¯",
    "bell": "ðŸ””",
    "no_bell": "ðŸ”•",
    "musical_score": "ðŸŽ¼",
    "musical_note": "ðŸŽµ",
    "notes": "ðŸŽ¶",
    "studio_microphone": "ðŸŽ™ï¸",
    "level_slider": "ðŸŽšï¸",
    "control_knobs": "ðŸŽ›ï¸",
    "microphone": "ðŸŽ¤",
    "headphones": "ðŸŽ§",
    "radio": "ðŸ“»",
    "saxophone": "ðŸŽ·",
    "accordion": "ðŸª—",
    "guitar": "ðŸŽ¸",
    "musical_keyboard": "ðŸŽ¹",
    "trumpet": "ðŸŽº",
    "violin": "ðŸŽ»",
    "banjo": "ðŸª•",
    "drum": "ðŸ¥",
    "long_drum": "ðŸª˜",
    "iphone": "ðŸ“±",
    "calling": "ðŸ“²",
    "phone": "â˜Žï¸",
    "telephone_receiver": "ðŸ“ž",
    "pager": "ðŸ“Ÿ",
    "fax": "ðŸ“ ",
    "battery": "ðŸ”‹",
    "electric_plug": "ðŸ”Œ",
    "computer": "ðŸ’»",
    "desktop_computer": "ðŸ–¥ï¸",
    "printer": "ðŸ–¨ï¸",
    "keyboard": "âŒ¨ï¸",
    "computer_mouse": "ðŸ–±ï¸",
    "trackball": "ðŸ–²ï¸",
    "minidisc": "ðŸ’½",
    "floppy_disk": "ðŸ’¾",
    "cd": "ðŸ’¿",
    "dvd": "ðŸ“€",
    "abacus": "ðŸ§®",
    "movie_camera": "ðŸŽ¥",
    "film_strip": "ðŸŽžï¸",
    "film_projector": "ðŸ“½ï¸",
    "clapper": "ðŸŽ¬",
    "tv": "ðŸ“º",
    "camera": "ðŸ“·",
    "camera_flash": "ðŸ“¸",
    "video_camera": "ðŸ“¹",
    "vhs": "ðŸ“¼",
    "mag": "ðŸ”",
    "mag_right": "ðŸ”Ž",
    "candle": "ðŸ•¯ï¸",
    "bulb": "ðŸ’¡",
    "flashlight": "ðŸ”¦",
    "izakaya_lantern": "ðŸ®",
    "diya_lamp": "ðŸª”",
    "notebook_with_decorative_cover": "ðŸ“”",
    "closed_book": "ðŸ“•",
    "book": "ðŸ“–",
    "green_book": "ðŸ“—",
    "blue_book": "ðŸ“˜",
    "orange_book": "ðŸ“™",
    "books": "ðŸ“š",
    "notebook": "ðŸ““",
    "ledger": "ðŸ“’",
    "page_with_curl": "ðŸ“ƒ",
    "scroll": "ðŸ“œ",
    "page_facing_up": "ðŸ“„",
    "newspaper": "ðŸ“°",
    "newspaper_roll": "ðŸ—žï¸",
    "bookmark_tabs": "ðŸ“‘",
    "bookmark": "ðŸ”–",
    "label": "ðŸ·ï¸",
    "moneybag": "ðŸ’°",
    "coin": "ðŸª™",
    "yen": "ðŸ’´",
    "dollar": "ðŸ’µ",
    "euro": "ðŸ’¶",
    "pound": "ðŸ’·",
    "money_with_wings": "ðŸ’¸",
    "credit_card": "ðŸ’³",
    "receipt": "ðŸ§¾",
    "chart": "ðŸ’¹",
    "envelope": "âœ‰ï¸",
    "email": "ðŸ“§",
    "incoming_envelope": "ðŸ“¨",
    "envelope_with_arrow": "ðŸ“©",
    "outbox_tray": "ðŸ“¤",
    "inbox_tray": "ðŸ“¥",
    "package": "ðŸ“¦",
    "mailbox": "ðŸ“«",
    "mailbox_closed": "ðŸ“ª",
    "mailbox_with_mail": "ðŸ“¬",
    "mailbox_with_no_mail": "ðŸ“­",
    "postbox": "ðŸ“®",
    "ballot_box": "ðŸ—³ï¸",
    "pencil2": "âœï¸",
    "black_nib": "âœ’ï¸",
    "fountain_pen": "ðŸ–‹ï¸",
    "pen": "ðŸ–Šï¸",
    "paintbrush": "ðŸ–Œï¸",
    "crayon": "ðŸ–ï¸",
    "memo": "ðŸ“",
    "briefcase": "ðŸ’¼",
    "file_folder": "ðŸ“",
    "open_file_folder": "ðŸ“‚",
    "card_index_dividers": "ðŸ—‚ï¸",
    "date": "ðŸ“…",
    "calendar": "ðŸ“†",
    "spiral_notepad": "ðŸ—’ï¸",
    "spiral_calendar": "ðŸ—“ï¸",
    "card_index": "ðŸ“‡",
    "chart_with_upwards_trend": "ðŸ“ˆ",
    "chart_with_downwards_trend": "ðŸ“‰",
    "bar_chart": "ðŸ“Š",
    "clipboard": "ðŸ“‹",
    "pushpin": "ðŸ“Œ",
    "round_pushpin": "ðŸ“",
    "paperclip": "ðŸ“Ž",
    "paperclips": "ðŸ–‡ï¸",
    "straight_ruler": "ðŸ“",
    "triangular_ruler": "ðŸ“",
    "scissors": "âœ‚ï¸",
    "card_file_box": "ðŸ—ƒï¸",
    "file_cabinet": "ðŸ—„ï¸",
    "wastebasket": "ðŸ—‘ï¸",
    "lock": "ðŸ”’",
    "unlock": "ðŸ”“",
    "lock_with_ink_pen": "ðŸ”",
    "closed_lock_with_key": "ðŸ”",
    "key": "ðŸ”‘",
    "old_key": "ðŸ—ï¸",
    "hammer": "ðŸ”¨",
    "axe": "ðŸª“",
    "pick": "â›ï¸",
    "hammer_and_pick": "âš’ï¸",
    "hammer_and_wrench": "ðŸ› ï¸",
    "dagger": "ðŸ—¡ï¸",
    "crossed_swords": "âš”ï¸",
    "gun": "ðŸ”«",
    "boomerang": "ðŸªƒ",
    "bow_and_arrow": "ðŸ¹",
    "shield": "ðŸ›¡ï¸",
    "carpentry_saw": "ðŸªš",
    "wrench": "ðŸ”§",
    "screwdriver": "ðŸª›",
    "nut_and_bolt": "ðŸ”©",
    "gear": "âš™ï¸",
    "clamp": "ðŸ—œï¸",
    "balance_scale": "âš–ï¸",
    "probing_cane": "ðŸ¦¯",
    "link": "ðŸ”—",
    "chains": "â›“ï¸",
    "hook": "ðŸª",
    "toolbox": "ðŸ§°",
    "magnet": "ðŸ§²",
    "ladder": "ðŸªœ",
    "alembic": "âš—ï¸",
    "test_tube": "ðŸ§ª",
    "petri_dish": "ðŸ§«",
    "dna": "ðŸ§¬",
    "microscope": "ðŸ”¬",
    "telescope": "ðŸ”­",
    "satellite": "ðŸ“¡",
    "syringe": "ðŸ’‰",
    "drop_of_blood": "ðŸ©¸",
    "pill": "ðŸ’Š",
    "adhesive_bandage": "ðŸ©¹",
    "stethoscope": "ðŸ©º",
    "door": "ðŸšª",
    "elevator": "ðŸ›—",
    "mirror": "ðŸªž",
    "window": "ðŸªŸ",
    "bed": "ðŸ›ï¸",
    "couch_and_lamp": "ðŸ›‹ï¸",
    "chair": "ðŸª‘",
    "toilet": "ðŸš½",
    "plunger": "ðŸª ",
    "shower": "ðŸš¿",
    "bathtub": "ðŸ›",
    "mouse_trap": "ðŸª¤",
    "razor": "ðŸª’",
    "lotion_bottle": "ðŸ§´",
    "safety_pin": "ðŸ§·",
    "broom": "ðŸ§¹",
    "basket": "ðŸ§º",
    "roll_of_paper": "ðŸ§»",
    "bucket": "ðŸª£",
    "soap": "ðŸ§¼",
    "toothbrush": "ðŸª¥",
    "sponge": "ðŸ§½",
    "fire_extinguisher": "ðŸ§¯",
    "shopping_cart": "ðŸ›’",
    "smoking": "ðŸš¬",
    "coffin": "âš°ï¸",
    "headstone": "ðŸª¦",
    "funeral_urn": "âš±ï¸",
    "moyai": "ðŸ—¿",
    "placard": "ðŸª§",
    "atm": "ðŸ§",
    "put_litter_in_its_place": "ðŸš®",
    "potable_water": "ðŸš°",
    "wheelchair": "â™¿",
    "mens": "ðŸš¹",
    "womens": "ðŸšº",
    "restroom": "ðŸš»",
    "baby_symbol": "ðŸš¼",
    "wc": "ðŸš¾",
    "passport_control": "ðŸ›‚",
    "customs": "ðŸ›ƒ",
    "baggage_claim": "ðŸ›„",
    "left_luggage": "ðŸ›…",
    "warning": "âš ï¸",
    "children_crossing": "ðŸš¸",
    "no_entry": "â›”",
    "no_entry_sign": "ðŸš«",
    "no_bicycles": "ðŸš³",
    "no_smoking": "ðŸš­",
    "do_not_litter": "ðŸš¯",
    "non-potable_water": "ðŸš±",
    "no_pedestrians": "ðŸš·",
    "no_mobile_phones": "ðŸ“µ",
    "underage": "ðŸ”ž",
    "radioactive": "â˜¢ï¸",
    "biohazard": "â˜£ï¸",
    "arrow_up": "â¬†ï¸",
    "arrow_upper_right": "â†—ï¸",
    "arrow_right": "âž¡ï¸",
    "arrow_lower_right": "â†˜ï¸",
    "arrow_down": "â¬‡ï¸",
    "arrow_lower_left": "â†™ï¸",
    "arrow_left": "â¬…ï¸",
    "arrow_upper_left": "â†–ï¸",
    "arrow_up_down": "â†•ï¸",
    "left_right_arrow": "â†”ï¸",
    "leftwards_arrow_with_hook": "â†©ï¸",
    "arrow_right_hook": "â†ªï¸",
    "arrow_heading_up": "â¤´ï¸",
    "arrow_heading_down": "â¤µï¸",
    "arrows_clockwise": "ðŸ”ƒ",
    "arrows_counterclockwise": "ðŸ”„",
    "back": "ðŸ”™",
    "end": "ðŸ”š",
    "on": "ðŸ”›",
    "soon": "ðŸ”œ",
    "top": "ðŸ”",
    "place_of_worship": "ðŸ›",
    "atom_symbol": "âš›ï¸",
    "om": "ðŸ•‰ï¸",
    "star_of_david": "âœ¡ï¸",
    "wheel_of_dharma": "â˜¸ï¸",
    "yin_yang": "â˜¯ï¸",
    "latin_cross": "âœï¸",
    "orthodox_cross": "â˜¦ï¸",
    "star_and_crescent": "â˜ªï¸",
    "peace_symbol": "â˜®ï¸",
    "menorah": "ðŸ•Ž",
    "six_pointed_star": "ðŸ”¯",
    "aries": "â™ˆ",
    "taurus": "â™‰",
    "gemini": "â™Š",
    "cancer": "â™‹",
    "leo": "â™Œ",
    "virgo": "â™",
    "libra": "â™Ž",
    "scorpius": "â™",
    "sagittarius": "â™",
    "capricorn": "â™‘",
    "aquarius": "â™’",
    "pisces": "â™“",
    "ophiuchus": "â›Ž",
    "twisted_rightwards_arrows": "ðŸ”€",
    "repeat": "ðŸ”",
    "repeat_one": "ðŸ”‚",
    "arrow_forward": "â–¶ï¸",
    "fast_forward": "â©",
    "next_track_button": "â­ï¸",
    "play_or_pause_button": "â¯ï¸",
    "arrow_backward": "â—€ï¸",
    "rewind": "âª",
    "previous_track_button": "â®ï¸",
    "arrow_up_small": "ðŸ”¼",
    "arrow_double_up": "â«",
    "arrow_down_small": "ðŸ”½",
    "arrow_double_down": "â¬",
    "pause_button": "â¸ï¸",
    "stop_button": "â¹ï¸",
    "record_button": "âºï¸",
    "eject_button": "âï¸",
    "cinema": "ðŸŽ¦",
    "low_brightness": "ðŸ”…",
    "high_brightness": "ðŸ”†",
    "signal_strength": "ðŸ“¶",
    "vibration_mode": "ðŸ“³",
    "mobile_phone_off": "ðŸ“´",
    "female_sign": "â™€ï¸",
    "male_sign": "â™‚ï¸",
    "transgender_symbol": "âš§ï¸",
    "heavy_multiplication_x": "âœ–ï¸",
    "heavy_plus_sign": "âž•",
    "heavy_minus_sign": "âž–",
    "heavy_division_sign": "âž—",
    "infinity": "â™¾ï¸",
    "bangbang": "â€¼ï¸",
    "interrobang": "â‰ï¸",
    "question": "â“",
    "grey_question": "â”",
    "grey_exclamation": "â•",
    "exclamation": "â—",
    "wavy_dash": "ã€°ï¸",
    "currency_exchange": "ðŸ’±",
    "heavy_dollar_sign": "ðŸ’²",
    "medical_symbol": "âš•ï¸",
    "recycle": "â™»ï¸",
    "fleur_de_lis": "âšœï¸",
    "trident": "ðŸ”±",
    "name_badge": "ðŸ“›",
    "beginner": "ðŸ”°",
    "o": "â­•",
    "white_check_mark": "âœ…",
    "ballot_box_with_check": "â˜‘ï¸",
    "heavy_check_mark": "âœ”ï¸",
    "x": "âŒ",
    "negative_squared_cross_mark": "âŽ",
    "curly_loop": "âž°",
    "loop": "âž¿",
    "part_alternation_mark": "ã€½ï¸",
    "eight_spoked_asterisk": "âœ³ï¸",
    "eight_pointed_black_star": "âœ´ï¸",
    "sparkle": "â‡ï¸",
    "copyright": "Â©ï¸",
    "registered": "Â®ï¸",
    "tm": "â„¢ï¸",
    "hash": "#ï¸âƒ£",
    "asterisk": "*ï¸âƒ£",
    "zero": "0ï¸âƒ£",
    "one": "1ï¸âƒ£",
    "two": "2ï¸âƒ£",
    "three": "3ï¸âƒ£",
    "four": "4ï¸âƒ£",
    "five": "5ï¸âƒ£",
    "six": "6ï¸âƒ£",
    "seven": "7ï¸âƒ£",
    "eight": "8ï¸âƒ£",
    "nine": "9ï¸âƒ£",
    "keycap_ten": "ðŸ”Ÿ",
    "capital_abcd": "ðŸ” ",
    "abcd": "ðŸ”¡",
    "1234": "ðŸ”¢",
    "symbols": "ðŸ”£",
    "abc": "ðŸ”¤",
    "a": "ðŸ…°ï¸",
    "ab": "ðŸ†Ž",
    "b": "ðŸ…±ï¸",
    "cl": "ðŸ†‘",
    "cool": "ðŸ†’",
    "free": "ðŸ†“",
    "information_source": "â„¹ï¸",
    "id": "ðŸ†”",
    "m": "â“‚ï¸",
    "new": "ðŸ†•",
    "ng": "ðŸ†–",
    "o2": "ðŸ…¾ï¸",
    "ok": "ðŸ†—",
    "parking": "ðŸ…¿ï¸",
    "sos": "ðŸ†˜",
    "up": "ðŸ†™",
    "vs": "ðŸ†š",
    "koko": "ðŸˆ",
    "sa": "ðŸˆ‚ï¸",
    "u6708": "ðŸˆ·ï¸",
    "u6709": "ðŸˆ¶",
    "u6307": "ðŸˆ¯",
    "ideograph_advantage": "ðŸ‰",
    "u5272": "ðŸˆ¹",
    "u7121": "ðŸˆš",
    "u7981": "ðŸˆ²",
    "accept": "ðŸ‰‘",
    "u7533": "ðŸˆ¸",
    "u5408": "ðŸˆ´",
    "u7a7a": "ðŸˆ³",
    "congratulations": "ãŠ—ï¸",
    "secret": "ãŠ™ï¸",
    "u55b6": "ðŸˆº",
    "u6e80": "ðŸˆµ",
    "red_circle": "ðŸ”´",
    "orange_circle": "ðŸŸ ",
    "yellow_circle": "ðŸŸ¡",
    "green_circle": "ðŸŸ¢",
    "large_blue_circle": "ðŸ”µ",
    "purple_circle": "ðŸŸ£",
    "brown_circle": "ðŸŸ¤",
    "black_circle": "âš«",
    "white_circle": "âšª",
    "red_square": "ðŸŸ¥",
    "orange_square": "ðŸŸ§",
    "yellow_square": "ðŸŸ¨",
    "green_square": "ðŸŸ©",
    "blue_square": "ðŸŸ¦",
    "purple_square": "ðŸŸª",
    "brown_square": "ðŸŸ«",
    "black_large_square": "â¬›",
    "white_large_square": "â¬œ",
    "black_medium_square": "â—¼ï¸",
    "white_medium_square": "â—»ï¸",
    "black_medium_small_square": "â—¾",
    "white_medium_small_square": "â—½",
    "black_small_square": "â–ªï¸",
    "white_small_square": "â–«ï¸",
    "large_orange_diamond": "ðŸ”¶",
    "large_blue_diamond": "ðŸ”·",
    "small_orange_diamond": "ðŸ”¸",
    "small_blue_diamond": "ðŸ”¹",
    "small_red_triangle": "ðŸ”º",
    "small_red_triangle_down": "ðŸ”»",
    "diamond_shape_with_a_dot_inside": "ðŸ’ ",
    "radio_button": "ðŸ”˜",
    "white_square_button": "ðŸ”³",
    "black_square_button": "ðŸ”²",
    "checkered_flag": "ðŸ",
    "triangular_flag_on_post": "ðŸš©",
    "crossed_flags": "ðŸŽŒ",
    "black_flag": "ðŸ´",
    "white_flag": "ðŸ³ï¸",
    "rainbow_flag": "ðŸ³ï¸â€ðŸŒˆ",
    "transgender_flag": "ðŸ³ï¸â€âš§ï¸",
    "pirate_flag": "ðŸ´â€â˜ ï¸",
}


def strip_emojis(text):
    """Remove or replace emojis with ASCII alternatives for thermal printer."""
    # First try specific mappings
    for emoji, replacement in EMOJI_MAP.items():
        text = text.replace(emoji, replacement)
    
    # Remove any remaining emojis (Unicode ranges for common emoji blocks)
    # This regex covers most emoji ranges
    emoji_pattern = re.compile(
        "["
        "\U0001F600-\U0001F64F"  # emoticons
        "\U0001F300-\U0001F5FF"  # symbols & pictographs
        "\U0001F680-\U0001F6FF"  # transport & map symbols
        "\U0001F1E0-\U0001F1FF"  # flags (iOS)
        "\U00002702-\U000027B0"  # dingbats
        "\U000024C2-\U0001F251"
        "\U0001F900-\U0001F9FF"  # supplemental symbols
        "\U0001FA00-\U0001FA6F"  # extended symbols
        "]+", flags=re.UNICODE
    )
    text = emoji_pattern.sub('', text)
    return text

def detect_priority(message, payload=None):
    """Detect priority level from ntfy message payload.
    
    Supports:
    - ntfy numeric priority (1-5 scale)
    - Explicit priority field in JSON payload
    - Priority header values (min, low, default, high, max, urgent)
    
    Returns: ("max", "high", "default", "low", "min")
    """
    if not payload or not isinstance(payload, dict):
        return "default"
    
    # Check for numeric priority (ntfy uses 1-5 scale: 5=max, 4=high, 3=default, 2=low, 1=min)
    priority_value = payload.get("priority")
    if priority_value is not None:
        try:
            p = int(priority_value)
            if p >= 5:
                return "max"
            elif p >= 4:
                return "high"
            elif p >= 3:
                return "default"
            elif p >= 2:
                return "low"
            else:
                return "min"
        except (ValueError, TypeError):
            pass
    
    # Check for string priority values (e.g., from headers or explicit field)
    priority_str = payload.get("priority_str", payload.get("priority_level", "")).lower()
    if priority_str:
        if priority_str in ["5", "urgent", "critical", "max", "emergency"]:
            return "max"
        elif priority_str in ["4", "high"]:
            return "high"
        elif priority_str in ["3", "normal", "default", "medium"]:
            return "default"
        elif priority_str in ["2", "low"]:
            return "low"
        elif priority_str in ["1", "min", "minimal"]:
            return "min"
    
    return "default"


def get_priority_symbol(priority_level):
    """Get the alert symbol(s) and count for priority level.
    
    Returns: (symbol, count) tuple - symbol is emoji, count is repetitions
    """
    symbols = {
        "max": ("âš¡", 3),      # 3 lightning bolts for max
        "high": ("âš¡", 2),     # 2 lightning bolts for high
        "default": ("âš¡", 1),  # 1 lightning bolt for default
        "low": ("â†“", 1),       # Down arrow for low
        "min": ("â€¢", 1),       # Bullet for minimal
    }
    return symbols.get(priority_level, ("âš¡", 1))


def draw_priority_banner(draw, x, y, width, height, priority, font, text_color=(0, 0, 0), bg_color=(200, 200, 200)):
    """Draw a priority banner with visual styling based on priority level.
    
    Args:
        draw: PIL ImageDraw object
        x, y: Top-left coordinates
        width, height: Banner dimensions
        priority: One of "critical", "high", "medium", "low"
        font: PIL Font for text
        text_color: RGB tuple for text
        bg_color: RGB tuple for background
    
    Returns: Text to display in banner
    """
    # Define visual styles per priority
    styles = {
        "critical": {
            "text": "âš  CRITICAL âš ",
            "fill": (255, 100, 100),  # Red
            "pattern": "heavy",  # Dense shading
        },
        "high": {
            "text": "â— HIGH â—",
            "fill": (255, 180, 100),  # Orange
            "pattern": "medium",
        },
        "medium": {
            "text": "â—‹ MEDIUM â—‹",
            "fill": (255, 255, 100),  # Yellow
            "pattern": "light",
        },
        "low": {
            "text": "- LOW -",
            "fill": (200, 255, 200),  # Light green
            "pattern": "minimal",
        },
    }
    
    style = styles.get(priority.lower(), styles["medium"])
    fill = style["fill"]
    banner_text = style["text"]
    pattern = style["pattern"]
    
    # Draw background rectangle with border
    border_width = 2
    draw.rectangle([x, y, x + width - 1, y + height - 1], fill=fill, outline=(0, 0, 0), width=border_width)
    
    # Add pattern/shading based on priority (thicker line = higher priority)
    if pattern == "heavy":
        # Dense lines for critical
        for line_y in range(y + 5, y + height - 5, 2):
            draw.line([x + 5, line_y, x + width - 5, line_y], fill=(100, 0, 0), width=1)
    elif pattern == "medium":
        # Medium spacing for high
        for line_y in range(y + 5, y + height - 5, 3):
            draw.line([x + 5, line_y, x + width - 5, line_y], fill=(150, 80, 0), width=1)
    elif pattern == "light":
        # Light spacing for medium
        for line_y in range(y + 5, y + height - 5, 5):
            draw.line([x + 5, line_y, x + width - 5, line_y], fill=(150, 150, 0), width=1)
    
    # Draw text centered in banner
    text_bbox = draw.textbbox((0, 0), banner_text, font=font)
    text_width = text_bbox[2] - text_bbox[0]
    text_height = text_bbox[3] - text_bbox[1]
    text_x = x + (width - text_width) // 2
    text_y = y + (height - text_height) // 2
    draw.text((text_x, text_y), banner_text, font=font, fill=(0, 0, 0))
    
    return banner_text

# Image processing controls for printer compatibility
IMAGE_IMPL = os.environ.get("IMAGE_IMPL", "bitImageColumn")
IMAGE_IMPLS = os.environ.get("IMAGE_IMPLS")
IMAGE_SCALE = int(os.environ.get("IMAGE_SCALE", "2"))
IMAGE_CONTRAST = float(os.environ.get("IMAGE_CONTRAST", "2.0"))
# global stop event used to exit loops cleanly
STOP_EVENT = threading.Event()
MONITOR = None

class WhiteboardPrinter:
    def __init__(self, preview_mode=False):
        self.p = None
        self._paused = False
        self.preview_mode = preview_mode
        self.preview_count = 0
        if not preview_mode:
            self.connect()

    def set_paused(self, paused: bool):
        self._paused = bool(paused)

    @property
    def is_paused(self):
        return self._paused

    def connect(self):
        if self.preview_mode:
            print("ðŸ“¸ Preview mode - no printer connection needed")
            return
        
        try:
            if PRINTER_PROFILE:
                self.p = Usb(VENDOR_ID, PRODUCT_ID, 0, profile=PRINTER_PROFILE)
            else:
                self.p = Usb(VENDOR_ID, PRODUCT_ID, 0)
            # detach kernel driver if active
            try:
                if self.p.device.is_kernel_driver_active(0):
                    self.p.device.detach_kernel_driver(0)
            except Exception:
                # device/kernel driver info may not be available on some platforms
                logging.debug("Could not check/detach kernel driver")
            # Give USB device time to settle after connection
            time.sleep(0.5)
            print("ðŸŸ¢ Hardware Linked")
        except Exception:
            logging.exception("Failed to connect to USB printer")
            self.p = None

    def create_layout(self, message, subtext=None, priority="default", payload=None):
        """Create layout with ntfy fields: tags/priority (header), title, divider, message, QR if click present."""
        # Compute width from paper size and printer DPI, with safe margins
        full_width = int(round(PAPER_WIDTH_MM / 25.4 * PRINTER_DPI))
        safe_margin_px = int(round(SAFE_MARGIN_MM / 25.4 * PRINTER_DPI))
        width = full_width - (2 * safe_margin_px)  # Subtract margins from usable width
        x_offset_px = int(round(X_OFFSET_MM / 25.4 * PRINTER_DPI))
        y_offset_px = int(round(Y_OFFSET_MM / 25.4 * PRINTER_DPI))
        left_margin = safe_margin_px + x_offset_px  # Left edge accounting for offset

        # MASSIVE font sizes (swapped: title large, message medium)
        font_main_size = 40      # Message size
        font_sub_size = 35
        font_title_size = 70     # Title size (also used for emoji header)
        font_subtext_size = 24

        try:
            font_bold = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", font_title_size)
            font_message = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", font_main_size)
            font_reg = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", font_sub_size)
            font_title = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", font_title_size)
            font_subtext = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", font_subtext_size)
        except Exception:
            logging.warning("Could not load TTF fonts; falling back to default font")
            font_bold = font_message = font_reg = font_title = font_subtext = ImageFont.load_default()

        # Extract fields from ntfy payload
        payload = payload or {}
        tags = payload.get("tags", "")  # comma-separated string or list
        title = payload.get("title", "")
        click_url = payload.get("click", "")  # URL for QR code

        # Parse tags (can be comma-separated string or list)
        if isinstance(tags, str):
            tags_list = [t.strip() for t in tags.split(",") if t.strip()]
        else:
            tags_list = tags if isinstance(tags, list) else []

        # Convert tag names to emoji using mapping
        translated_tags = []
        for tag in tags_list:
            # Check if tag is a name in EMOJI_TAG_MAP
            if tag in EMOJI_TAG_MAP:
                translated_tags.append(EMOJI_TAG_MAP[tag])
            else:
                # Otherwise use tag as-is (might already be emoji)
                translated_tags.append(tag)

        # Header: tags OR priority icon (keep current logic if no tags)
        if translated_tags:
            header_text = " | ".join(translated_tags)
        else:
            # Fall back to priority symbol if no tags
            symbol, count = get_priority_symbol(priority)
            header_text = symbol * count

        # Enforce message caps to avoid unbounded image sizes
        if len(message) > MAX_MESSAGE_LENGTH:
            message = message[:MAX_MESSAGE_LENGTH-3] + "..."

        # Wrap main message (large centered text)
        wrapped = textwrap.wrap(message, width=10)
        lines = wrapped[:MAX_LINES]
        if len(wrapped) > MAX_LINES and lines:
            lines[-1] = (lines[-1][:max(0, len(lines[-1]) - 3)] + "...")

        # Measure text sizes to build a tight canvas
        sample_main_bbox = font_bold.getbbox("Ag")
        main_line_height = sample_main_bbox[3] - sample_main_bbox[1]
        sample_sub_bbox = font_reg.getbbox("Ag")
        sub_line_height = sample_sub_bbox[3] - sample_sub_bbox[1]
        sample_title_bbox = font_title.getbbox("Ag")
        title_line_height = sample_title_bbox[3] - sample_title_bbox[1]
        sample_subtext_bbox = font_subtext.getbbox("Ag")
        subtext_line_height = sample_subtext_bbox[3] - sample_subtext_bbox[1]

        top_pad = 20
        header_gap = 80      # More spacing for large 70px emoji
        title_gap = 15
        line_gap = 10
        divider_gap = 15
        date_gap = 25
        subtext_gap = 10
        bottom_pad = 20

        # Calculate header height
        header_bbox = font_bold.getbbox(header_text)
        header_height = header_bbox[3] - header_bbox[1]

        # Calculate title height
        title_height = 0
        if title:
            title_wrapped = textwrap.wrap(title, width=12)
            title_height = (len(title_wrapped) * title_line_height) + (max(0, len(title_wrapped) - 1) * line_gap)

        # Main message height
        lines_height = (len(lines) * main_line_height) + (max(0, len(lines) - 1) * line_gap)

        # QR code height (if click URL present)
        qr_height = 0
        qr_img = None
        if click_url:
            qr_size = 100
            qr_height = qr_size + subtext_gap
            try:
                qr = qrcode.QRCode(version=1, box_size=3, border=1)
                qr.add_data(click_url)
                qr.make()
                qr_img = qr.make_image(fill_color="black", back_color="white")
                qr_img = qr_img.resize((qr_size, qr_size), Image.NEAREST)
            except Exception as e:
                logging.warning("QR generation failed: %s", e)
                qr_height = 0

        # Calculate total height
        total_height = (
            top_pad +
            header_height + header_gap +
            (title_height + title_gap if title else 0) +
            lines_height +
            divider_gap + 3 + date_gap +
            sub_line_height + 5 +  # date
            sub_line_height +  # time
            qr_height +
            bottom_pad
        )

        canvas = Image.new('RGB', (full_width, total_height), color=(255, 255, 255))
        draw = ImageDraw.Draw(canvas)

        y = top_pad + y_offset_px

        # 1. Header (tags or priority symbol)
        # For emoji, center by estimating character width (each emoji ~50px at size 70)
        char_width = font_title_size * 0.55  # ~55% of font size per emoji
        estimated_width = len(header_text) * char_width
        header_x = int(left_margin + (width - estimated_width) / 2)
        # Use Pilmoji to render emoji in tags
        with Pilmoji(canvas) as pilmoji:
            pilmoji.text((header_x, y), header_text, (0, 0, 0), font_bold)
        y += header_height + header_gap

        # 2. Title (if present)
        if title:
            title_wrapped = textwrap.wrap(title, width=12)
            for title_line in title_wrapped:
                title_bbox = draw.textbbox((0, 0), title_line, font=font_title)
                title_x = (width - (title_bbox[2] - title_bbox[0])) // 2 + left_margin
                draw.text((title_x, y), title_line, font=font_title, fill=(0, 0, 0))
                y += title_line_height + line_gap
            
            # Divider line after title
            y += title_gap
            draw.line([left_margin + 20, y, left_margin + width - 20, y], fill=(0, 0, 0), width=3)
            y += divider_gap

        # 3. Main message text (centered, large)
        for line in lines:
            bbox = draw.textbbox((0, 0), line, font=font_message)
            draw.text(((width - (bbox[2]-bbox[0]))//2 + left_margin, y), line, font=font_message, fill=(0, 0, 0))
            y += main_line_height + line_gap

        # 4. Divider line
        y += divider_gap
        draw.line([left_margin + 20, y, left_margin + width - 20, y], fill=(0, 0, 0), width=3)
        y += date_gap

        # 5. Date/Time (centered, smaller)
        date_str = time.strftime("%b %d, %Y")
        time_str = time.strftime("%H:%M:%S")
        bbox = draw.textbbox((0, 0), date_str, font=font_reg)
        draw.text(((width - (bbox[2]-bbox[0]))//2 + left_margin, y), date_str, font=font_reg, fill=(0, 0, 0))
        y += sub_line_height + 5
        bbox_time = draw.textbbox((0, 0), time_str, font=font_reg)
        draw.text(((width - (bbox_time[2]-bbox_time[0]))//2 + left_margin, y), time_str, font=font_reg, fill=(0, 0, 0))
        y += sub_line_height

        # 6. QR code (if click URL present, centered at bottom)
        if qr_img:
            y += subtext_gap
            qr_x = (width - qr_img.width) // 2 + left_margin
            canvas.paste(qr_img, (qr_x, y))
            y += qr_img.height

        y += bottom_pad
        return canvas

    def render_structured(self, payload):
        """Render structured JSON payloads (e.g., monday.com tasks)."""
        msg_type = payload.get("type", "generic")
        
        if msg_type == "monday_task":
            return self._render_monday_task(payload)
        elif msg_type == "text_with_subtext":
            message = payload.get("message", "Message")
            subtext = payload.get("subtext")
            return self.create_layout(strip_emojis(message), subtext=subtext)
        elif msg_type == "priority_alert":
            return self._render_priority_alert(payload)
        else:
            # Generic fallback
            return self.create_layout(json.dumps(payload))
    
    def _render_monday_task(self, payload):
        """Kanban card style layout (monochrome) with borders and priority indicator."""
        full_width = int(round(PAPER_WIDTH_MM / 25.4 * PRINTER_DPI))
        safe_margin_px = int(round(SAFE_MARGIN_MM / 25.4 * PRINTER_DPI))
        x_offset_px = int(round(X_OFFSET_MM / 25.4 * PRINTER_DPI))
        y_offset_px = int(round(Y_OFFSET_MM / 25.4 * PRINTER_DPI))
        left_margin = safe_margin_px + x_offset_px
        
        try:
            font_title = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 28)
            font_meta = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 16)
            font_small = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 13)
        except Exception:
            font_title = font_meta = font_small = ImageFont.load_default()
        
        # Extract fields
        task_name = payload.get("task", "Task").strip()[:50]
        priority = payload.get("priority", "medium").lower()
        status = payload.get("status", "todo").lower()
        assignee = payload.get("assignee", "").upper()[:3]
        due_date = payload.get("due_date", "")[:10]
        ref_id = payload.get("id", payload.get("ref_id", ""))
        qr_data = payload.get("qr_url") or payload.get("url")
        
        # Priority indicator width (monochrome: thicker = higher priority)
        priority_widths = {
            "critical": 8,
            "high": 6,
            "medium": 4,
            "low": 2,
        }
        priority_width = priority_widths.get(priority, 3)
        
        # Calculate dimensions with safe margins
        qr_size = 80 if qr_data else 0
        card_height = 220 + qr_size
        card_width = full_width - (2 * safe_margin_px)
        padding = 15
        card_x = left_margin
        card_y = 10 + y_offset_px
        
        canvas = Image.new('RGB', (full_width, card_height), color=(255, 255, 255))
        draw = ImageDraw.Draw(canvas)
        
        # Card border/frame (black)
        draw.rectangle(
            [card_x, card_y, card_x + card_width, card_y + card_height - 15],
            outline=(0, 0, 0),
            width=2
        )
        
        # Priority indicator bar (left side, varying thickness based on priority)
        draw.rectangle(
            [card_x, card_y, card_x + priority_width, card_y + card_height - 15],
            fill=(0, 0, 0),
            outline=(0, 0, 0)
        )
        
        # Content area
        y = card_y + padding
        content_x = card_x + padding + 5 + 5
        
        # Task title (wrapped, bold)
        lines = textwrap.wrap(task_name, width=18)
        for line in lines[:2]:
            draw.text((content_x, y), line, font=font_title, fill=(0, 0, 0))
            y += 32
        
        y += 8
        
        # Status badge / icon
        status_icon = ICON_STATUS.get(status, "[?]")
        priority_icon = ICON_PRIORITY.get(priority, "[!]")
        draw.text((content_x, y), f"{status_icon} {priority_icon}", font=font_meta, fill=(0, 0, 0))
        y += 24
        
        # Metadata row: assignee and due date
        meta_parts = []
        if assignee:
            meta_parts.append(f"@{assignee}")
        if due_date:
            meta_parts.append(f"{due_date}")
        
        if meta_parts:
            meta_text = "  |  ".join(meta_parts)
            draw.text((content_x, y), meta_text, font=font_small, fill=(0, 0, 0))
            y += 20
        
        # Reference ID
        if ref_id:
            draw.text((content_x, y), f"#{ref_id}", font=font_small, fill=(0, 0, 0))
            y += 18
        
        # QR code (bottom right corner of card)
        if qr_data:
            try:
                qr = qrcode.QRCode(version=1, box_size=3, border=1)
                qr.add_data(qr_data)
                qr.make()
                qr_img = qr.make_image(fill_color="black", back_color="white")
                qr_resized = qr_img.resize((70, 70), Image.NEAREST)
                qr_x = card_x + card_width - 75
                qr_y = card_y + card_height - 85
                canvas.paste(qr_resized, (qr_x, qr_y))
            except Exception as e:
                logging.warning("QR generation failed: %s", e)
        
        return canvas

    def _render_priority_alert(self, payload):
        """Render a priority-based alert with visual banner and optional subtext."""
        full_width = int(round(PAPER_WIDTH_MM / 25.4 * PRINTER_DPI))
        safe_margin_px = int(round(SAFE_MARGIN_MM / 25.4 * PRINTER_DPI))
        x_offset_px = int(round(X_OFFSET_MM / 25.4 * PRINTER_DPI))
        y_offset_px = int(round(Y_OFFSET_MM / 25.4 * PRINTER_DPI))
        left_margin = safe_margin_px + x_offset_px
        
        try:
            font_banner = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 28)
            font_subtext = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 20)
        except Exception:
            font_banner = font_subtext = ImageFont.load_default()
        
        priority = payload.get("priority", "medium").lower()
        message = payload.get("message", "Alert")
        subtext = payload.get("subtext", "")
        
        width = full_width - (2 * safe_margin_px)
        banner_height = 80
        padding = 15
        
        # Calculate total height
        total_height = banner_height + padding + padding
        if subtext:
            subtext_bbox = ImageFont.load_default().getbbox("Ag")
            subtext_height = (subtext_bbox[3] - subtext_bbox[1]) + padding
            total_height += subtext_height
        
        canvas = Image.new('RGB', (full_width, total_height), color=(255, 255, 255))
        draw = ImageDraw.Draw(canvas)
        
        # Draw priority banner
        banner_x = left_margin
        banner_y = padding + y_offset_px
        draw_priority_banner(draw, banner_x, banner_y, width, banner_height, priority, font_banner)
        
        # Draw subtext if provided
        if subtext:
            subtext_y = banner_y + banner_height + padding
            subtext_bbox = draw.textbbox((0, 0), subtext, font=font_subtext)
            subtext_x = left_margin + (width - (subtext_bbox[2] - subtext_bbox[0])) // 2
            draw.text((subtext_x, subtext_y), strip_emojis(subtext), font=font_subtext, fill=(80, 80, 80))
        
        return canvas

    def create_alignment_test(self):
        # Build a simple alignment test using the same layout as regular messages
        width = int(round(PAPER_WIDTH_MM / 25.4 * PRINTER_DPI))
        height = int(round(width * 1.2))
        x_offset_px = int(round(X_OFFSET_MM / 25.4 * PRINTER_DPI))

        canvas = Image.new('RGB', (width, height), color=(255, 255, 255))
        draw = ImageDraw.Draw(canvas)

        # Border
        draw.rectangle([0, 0, width - 1, height - 1], outline=(0, 0, 0), width=2)

        # Center line (vertical) - apply offset
        cx = width // 2 + x_offset_px
        draw.line([cx, 0, cx, height], fill=(0, 0, 0), width=3)

        # Tick marks every 10 mm
        mm_to_px = PRINTER_DPI / 25.4
        for mm in range(0, int(PAPER_WIDTH_MM) + 1, 10):
            x = int(round(mm * mm_to_px)) + x_offset_px
            draw.line([x, 0, x, 15], fill=(0, 0, 0), width=1)
            draw.line([x, height - 15, x, height], fill=(0, 0, 0), width=1)

        # Simple text label
        try:
            font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 20)
        except Exception:
            font = ImageFont.load_default()
        
        label1 = f"X_OFFSET_MM={X_OFFSET_MM}"
        label2 = f"Center at {PAPER_WIDTH_MM/2}mm"
        bbox1 = draw.textbbox((0, 0), label1, font=font)
        bbox2 = draw.textbbox((0, 0), label2, font=font)
        draw.text(((width - (bbox1[2]-bbox1[0]))//2, height//2 - 30), label1, font=font, fill=(0, 0, 0))
        draw.text(((width - (bbox2[2]-bbox2[0]))//2, height//2 + 10), label2, font=font, fill=(0, 0, 0))

        return canvas

    def print_msg(self, message, subtext=None, payload=None):
        if self.is_paused:
            logging.warning("Printer paused due to high memory â€” dropping message")
            return
        if not self.p:
            self.connect()
        
        # Detect if message is JSON (structured payload)
        try:
            msg_payload = json.loads(message)
            if isinstance(msg_payload, dict) and "type" in msg_payload:
                # Structured payload â€” use template (filter emojis from task names)
                if "task" in msg_payload:
                    msg_payload["task"] = strip_emojis(msg_payload["task"])
                img = self.render_structured(msg_payload)
            else:
                # Fallback to plain text layout with optional subtext
                # Detect priority from payload (ntfy priority data)
                priority = detect_priority(message, payload or msg_payload)
                img = self.create_layout(strip_emojis(message), subtext=subtext, priority=priority, payload=payload or msg_payload)
        except (json.JSONDecodeError, ValueError):
            # Plain text message - strip emojis, with optional subtext
            # Detect priority from ntfy payload (if provided)
            priority = detect_priority(message, payload)
            img = self.create_layout(strip_emojis(message), subtext=subtext, priority=priority, payload=payload)
        
        # Preview mode - show image instead of printing
        if self.preview_mode:
            scale = max(1, IMAGE_SCALE)
            scaled_width = img.width * scale
            scaled_height = img.height * scale
            img_scaled = img.resize((scaled_width, scaled_height), Image.NEAREST)
            img_mono = img_scaled.convert("L")
            img_mono = ImageOps.autocontrast(img_mono)
            img_mono = ImageEnhance.Contrast(img_mono).enhance(IMAGE_CONTRAST)
            img_final = img_mono.convert("1")
            
            self.preview_count += 1
            timestamp = time.strftime("%H:%M:%S")
            print(f"\n[{timestamp}] Preview #{self.preview_count}: {message[:60]}{'...' if len(message) > 60 else ''}")
            print(f"   Resolution: {img_final.width}x{img_final.height}px")
            print(f"   Paper: {PAPER_WIDTH_MM}mm ({PAPER_WIDTH_PX}px @ {PRINTER_DPI} DPI)")
            print(f"   Printable: {PAPER_WIDTH_MM - 2*SAFE_MARGIN_MM}mm ({MAX_PRINTABLE_WIDTH_PX}px)")
            img_final.show()
            return
        
        # Retry logic for USB operations (handles transient device errors)
        max_retries = 3
        retry_delay = 1.0
        
        for attempt in range(max_retries):
            try:
                if not self.p:
                    # No printer available; log and skip printing instead of crashing
                    logging.warning("No printer connected â€” skipping print: %s", message)
                    return
                self.p.hw("INIT")
                # Scale and convert to printer-friendly monochrome image
                scale = max(1, IMAGE_SCALE)
                scaled_width = img.width * scale
                scaled_height = img.height * scale
                img_scaled = img.resize((scaled_width, scaled_height), Image.NEAREST)
                img_mono = img_scaled.convert("L")
                img_mono = ImageOps.autocontrast(img_mono)
                img_mono = ImageEnhance.Contrast(img_mono).enhance(IMAGE_CONTRAST)
                img_mono = img_mono.convert("1")
                # Select implementation list
                if IMAGE_IMPLS:
                    impls = [i.strip() for i in IMAGE_IMPLS.split(',') if i.strip()]
                else:
                    impls = [IMAGE_IMPL]

                printed = False
                for impl in impls:
                    try:
                        self.p.image(img_mono, impl=impl)
                        printed = True
                        break
                    except TypeError:
                        # Fallback for older escpos versions
                        self.p.image(img_mono)
                        printed = True
                        break
                    except Exception:
                        logging.exception("Image print failed with impl=%s", impl)

                if not printed:
                    logging.error("All image implementations failed. Try IMAGE_IMPLS=bitImageColumn,bitImageRaster,graphics,raster or set PRINTER_PROFILE.")
                self.p.text("\n\n\n\n")
                self.p.cut()
                print(f"âœ… Printed: {message[:50]}")
                break  # Success - exit retry loop
            except Exception as e:
                # Check if it's a USB error that might be transient
                is_usb_error = "USBError" in str(type(e).__name__) or "Entity not found" in str(e) or "No such device" in str(e)
                
                if is_usb_error and attempt < max_retries - 1:
                    logging.warning("USB error on attempt %d/%d: %s - retrying after %.1fs", attempt + 1, max_retries, e, retry_delay)
                    time.sleep(retry_delay)
                    retry_delay *= 2  # Exponential backoff
                    # Try reconnecting
                    self.connect()
                    continue
                else:
                    logging.exception("Printing error (attempt %d/%d)", attempt + 1, max_retries)
                    # Final attempt failed - reconnect for next message
                    self.connect()
                    break
        
        # Cleanup images after all retry attempts
        if 'img' in locals():
            try:
                del img
            except Exception:
                pass
        if 'img_scaled' in locals():
            try:
                del img_scaled
            except Exception:
                pass
        if 'img_mono' in locals():
            try:
                del img_mono
            except Exception:
                pass
        gc.collect()

def listen(ntfy_url, preview_mode=False):
    global MONITOR
    wp = WhiteboardPrinter(preview_mode=preview_mode)
    
    mode_str = "preview mode" if preview_mode else "printer mode"
    print(f"ðŸ‘€ Listening to {ntfy_url} ({mode_str})")
    if preview_mode:
        print(f"ðŸ“¸ Previews will open automatically for each message")
    print(f"   Press Ctrl+C to stop\n")
    
    logging.info("Listening to %s", ntfy_url)
    # Start memory monitor (skip in preview mode)
    if not preview_mode:
        MONITOR = MemoryMonitor(wp)
        MONITOR.start()
    while not STOP_EVENT.is_set():
        try:
            # use context manager to ensure response is closed
            with requests.get(ntfy_url, stream=True, timeout=None) as r:
                r.raise_for_status()
                for line in r.iter_lines(decode_unicode=True):
                    if STOP_EVENT.is_set():
                        break
                    if line:
                        try:
                            payload = json.loads(line)
                        except Exception:
                            logging.warning("Received non-json line: %s", line)
                            continue
                        msg = payload.get("message", "")
                        if msg:
                            # enforce a local truncation/caps before printing
                            if len(msg) > MAX_MESSAGE_LENGTH:
                                msg = msg[:MAX_MESSAGE_LENGTH-3] + "..."
                            # Extract priority from ntfy payload (numeric 1-5 scale)
                            wp.print_msg(msg, payload=payload)
        except Exception:
            if STOP_EVENT.is_set():
                break
            logging.exception("Connection to ntfy failed â€” retrying in 5s")
            time.sleep(5)
    # stop monitor on exit
    try:
        if MONITOR:
            MONITOR.stop()
            MONITOR.join(timeout=2.0)
    except Exception:
        logging.debug("Error stopping monitor")


class MemoryMonitor(threading.Thread):
    """Background thread checking memory usage and pausing printing when high.

    If memory usage rises above MEM_THRESHOLD_PERCENT, printing is paused until
    usage drops below MEM_RESUME_PERCENT.
    """
    def __init__(self, printer: WhiteboardPrinter, interval: float = 5.0):
        super().__init__(daemon=True)
        self.printer = printer
        self.interval = interval
        self._stop_event = threading.Event()

    def run(self):
        while not self._stop_event.is_set():
            try:
                used_percent = self._get_mem_percent()
                if used_percent is None:
                    # Unable to determine memory usage; skip
                    time.sleep(self.interval)
                    continue
                if used_percent >= MEM_THRESHOLD_PERCENT and not self.printer.is_paused:
                    logging.warning("Memory usage high (%.1f%%) â€” pausing printer", used_percent)
                    self.printer.set_paused(True)
                elif used_percent <= MEM_RESUME_PERCENT and self.printer.is_paused:
                    logging.info("Memory usage normal (%.1f%%) â€” resuming printer", used_percent)
                    self.printer.set_paused(False)
            except Exception:
                logging.exception("Memory monitor error")
            time.sleep(self.interval)

    def stop(self):
        self._stop_event.set()

    def _get_mem_percent(self):
        try:
            if psutil:
                return psutil.virtual_memory().percent
            # fallback: read /proc/meminfo
            with open('/proc/meminfo', 'r') as f:
                info = f.read()
            mem_total = None
            mem_available = None
            for line in info.splitlines():
                if line.startswith('MemTotal:'):
                    mem_total = int(line.split()[1])
                elif line.startswith('MemAvailable:'):
                    mem_available = int(line.split()[1])
            if mem_total and mem_available:
                used = mem_total - mem_available
                return used / mem_total * 100.0
        except Exception:
            logging.exception("Failed to read memory usage")
        return None


def shutdown(signum, frame):
    logging.info("Shutting down (signal %s)", signum)
    # signal listen loop and monitor to stop
    try:
        STOP_EVENT.set()
        if MONITOR:
            MONITOR.stop()
            MONITOR.join(timeout=2.0)
    except Exception:
        logging.debug("Error during shutdown cleanup")
    sys.exit(0)


def main():
    parser = argparse.ArgumentParser(description="Receipt printer listening to an ntfy topic")
    parser.add_argument("--host", default=DEFAULT_NTFY_HOST, help="ntfy host (including scheme)")
    parser.add_argument("--topic", default=DEFAULT_NTFY_TOPIC, help="ntfy topic name")
    parser.add_argument("--test-align", action="store_true", help="print alignment test and exit")
    parser.add_argument("--preview", "-p", action="store_true", help="preview mode - show images instead of printing")
    parser.add_argument("--example", "-e", choices=["text", "kanban"], help="show example message")
    args = parser.parse_args()
    
    # Example mode
    if args.example:
        if args.example == "text":
            message = "Lunch Time! ðŸ•ðŸ”"
            print(f"Example plain text: {message}")
        elif args.example == "kanban":
            message = json.dumps({
                "type": "monday_task",
                "task": "Design Homepage",
                "priority": "high",
                "status": "in_progress",
                "assignee": "JD",
                "due_date": "2026-02-15",
                "id": "M123",
                "qr_url": "https://monday.com/boards/123"
            })
            print(f"Example kanban card:\n{message}")
        
        wp = WhiteboardPrinter(preview_mode=True)
        wp.print_msg(message)
        sys.exit(0)

    if args.test_align:
        wp = WhiteboardPrinter()
        img = wp.create_alignment_test()
        # use the same print pipeline for calibration
        wp.print_msg("ALIGNMENT TEST")
        try:
            # print test image directly
            img_mono = img.convert("L")
            img_mono = ImageOps.autocontrast(img_mono)
            img_mono = ImageEnhance.Contrast(img_mono).enhance(IMAGE_CONTRAST)
            img_mono = img_mono.convert("1")
            if IMAGE_IMPLS:
                impls = [i.strip() for i in IMAGE_IMPLS.split(',') if i.strip()]
            else:
                impls = [IMAGE_IMPL]
            for impl in impls:
                try:
                    wp.p.image(img_mono, impl=impl)
                    break
                except TypeError:
                    wp.p.image(img_mono)
                    break
        finally:
            wp.p.text("\n\n\n\n")
            wp.p.cut()
        sys.exit(0)

    if not args.host or not args.topic:
        logging.error("NTFY host/topic not provided. Set NTFY_HOST and NTFY_TOPIC in environment or pass --host/--topic.")
        logging.error("Copy .env.template to .env and fill in NTFY_HOST/NTFY_TOPIC before running.")
        sys.exit(2)

    ntfy_url = f"{args.host.rstrip('/')}/{args.topic}/json"

    logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s %(message)s")
    signal.signal(signal.SIGINT, shutdown)
    signal.signal(signal.SIGTERM, shutdown)

    listen(ntfy_url, preview_mode=args.preview)


if __name__ == "__main__":
    main()